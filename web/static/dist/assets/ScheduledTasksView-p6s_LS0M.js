import{s as c}from"./index-azKvCBLj.js";import{d as X,A as Y,H as Z,I as ee,a as q,b as V,c as le,w as o,C as A,f as a,r as v,E as u,i,J as ae,o as E,j as d,D as C,K as M}from"./element-plus-DT46MLQ6.js";import{_ as te}from"./_plugin-vue_export-helper-DlAUqK2U.js";const oe={class:"scheduled-tasks"},ne={class:"header"},se={class:"header-right"},ue={key:0},re={style:{display:"flex","justify-content":"center","margin-top":"20px"}},ie=X({__name:"ScheduledTasksView",setup(de){const U=v(!1),P=v([]),p=v({page:1,pageSize:10,total:0}),k=v(!1),_=v(!1),g=v([]),w=v(null),m=v(""),n=v({name:"",description:"",cronExpr:"",enabled:!0,taskConfig:{images:[],batchSize:10,priority:5,maxRetries:0,retryStrategy:"linear",retryDelay:30,webhookUrl:""},overlapPolicy:"skip",timeoutSeconds:0}),f=async()=>{try{U.value=!0;const t=(p.value.page-1)*p.value.pageSize,e=await c.list({limit:p.value.pageSize,offset:t});P.value=e.tasks,p.value.total=e.total||e.tasks.length}catch{u.error("加载定时任务失败")}finally{U.value=!1}},N=async()=>{try{const t=m.value.split(`
`).map(s=>s.trim()).filter(s=>s.length>0);if(t.length===0){u.warning("请至少输入一个镜像地址");return}const e={...n.value,taskConfig:{...n.value.taskConfig,images:t}};await c.create(e),u.success("定时任务创建成功"),k.value=!1,m.value="",x(),f()}catch{u.error("创建定时任务失败")}},j=async t=>{try{t.enabled?(await c.disable(t.id),u.success("定时任务已禁用")):(await c.enable(t.id),u.success("定时任务已启用")),f()}catch{u.error("操作失败")}},I=async t=>{try{await c.trigger(t.id),u.success("定时任务已触发")}catch{u.error("触发失败")}},R=async t=>{try{await M.confirm("确定要删除这个定时任务吗？","确认删除",{type:"warning"}),await c.delete(t.id),u.success("定时任务已删除"),f()}catch(e){e!=="cancel"&&(console.error("Delete scheduled task error:",e),u.error(`删除失败: ${e instanceof Error?e.message:"未知错误"}`))}},F=async t=>{w.value={...t},n.value={name:t.name,description:t.description||"",cronExpr:t.cronExpr,enabled:t.enabled,taskConfig:{...t.taskConfig},overlapPolicy:t.overlapPolicy,timeoutSeconds:t.timeoutSeconds},m.value=t.taskConfig.images.join(`
`),_.value=!0},H=async()=>{try{if(!w.value)return;const t=m.value.split(`
`).map(s=>s.trim()).filter(s=>s.length>0);if(t.length===0){u.warning("请至少输入一个镜像地址");return}const e={...n.value,taskConfig:{...n.value.taskConfig,images:t}};await c.update(w.value.id,e),u.success("定时任务更新成功"),_.value=!1,w.value=null,x(),f()}catch{u.error("更新定时任务失败")}},J=async()=>{if(g.value.length===0){u.warning("请选择要删除的定时任务");return}try{await M.confirm(`确定要删除选中的 ${g.value.length} 个定时任务吗？`,"确认批量删除",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});const t=g.value.map(e=>c.delete(e.id));await Promise.all(t),u.success(`成功删除了 ${t.length} 个定时任务`),g.value=[],f()}catch(t){t!=="cancel"&&(console.error("Bulk delete scheduled tasks error:",t),u.error(`批量删除失败: ${t instanceof Error?t.message:"未知错误"}`))}},K=t=>{p.value.page=t,f()},L=t=>{p.value.pageSize=t,p.value.page=1,f()},x=()=>{n.value={name:"",description:"",cronExpr:"",enabled:!0,taskConfig:{images:[],batchSize:10,priority:5,maxRetries:0,retryStrategy:"linear",retryDelay:30,webhookUrl:""},overlapPolicy:"skip",timeoutSeconds:0},m.value="",w.value=null};return Y(()=>{f()}),Z(()=>{}),(t,e)=>{const s=i("el-button"),b=i("el-table-column"),G=i("el-tag"),O=i("el-table"),Q=i("el-pagination"),y=i("el-input"),r=i("el-form-item"),S=i("el-input-number"),D=i("el-switch"),z=i("el-option"),T=i("el-select"),$=i("el-form"),B=i("el-dialog"),W=ae("loading");return ee((E(),q("div",oe,[V("div",ne,[e[23]||(e[23]=V("h2",null,"定时任务管理",-1)),V("div",se,[g.value.length>0?(E(),le(s,{key:0,type:"danger",onClick:J,disabled:g.value.length===0},{default:o(()=>[d(" 批量删除 ("+C(g.value.length)+") ",1)]),_:1},8,["disabled"])):A("",!0),a(s,{type:"primary",onClick:e[0]||(e[0]=l=>k.value=!0)},{default:o(()=>[...e[22]||(e[22]=[d("新建定时任务",-1)])]),_:1})])]),a(O,{data:P.value,style:{width:"100%"},onSelectionChange:e[1]||(e[1]=l=>g.value=l)},{default:o(()=>[a(b,{type:"selection",width:"55"}),a(b,{prop:"name",label:"任务名称",width:"200"}),a(b,{prop:"cronExpr",label:"Cron表达式",width:"150"}),a(b,{prop:"taskConfig.images",label:"镜像","min-width":"200"},{default:o(({row:l})=>[d(C(l.taskConfig.images[0])+" ",1),l.taskConfig.images.length>1?(E(),q("span",ue,"+"+C(l.taskConfig.images.length-1),1)):A("",!0)]),_:1}),a(b,{prop:"enabled",label:"状态",width:"100"},{default:o(({row:l})=>[a(G,{type:l.enabled?"success":"info"},{default:o(()=>[d(C(l.enabled?"已启用":"已禁用"),1)]),_:2},1032,["type"])]),_:1}),a(b,{prop:"createdAt",label:"创建时间",width:"180"},{default:o(({row:l})=>[d(C(new Date(l.createdAt).toLocaleString()),1)]),_:1}),a(b,{label:"操作",width:"320",fixed:"right"},{default:o(({row:l})=>[a(s,{size:"small",onClick:h=>F(l)},{default:o(()=>[...e[24]||(e[24]=[d(" 编辑 ",-1)])]),_:1},8,["onClick"]),a(s,{size:"small",onClick:h=>j(l)},{default:o(()=>[d(C(l.enabled?"禁用":"启用"),1)]),_:2},1032,["onClick"]),a(s,{size:"small",type:"primary",onClick:h=>I(l)},{default:o(()=>[...e[25]||(e[25]=[d(" 触发 ",-1)])]),_:1},8,["onClick"]),a(s,{size:"small",type:"danger",onClick:h=>R(l)},{default:o(()=>[...e[26]||(e[26]=[d(" 删除 ",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"]),V("div",re,[a(Q,{"current-page":p.value.page,"onUpdate:currentPage":e[2]||(e[2]=l=>p.value.page=l),"page-size":p.value.pageSize,"onUpdate:pageSize":e[3]||(e[3]=l=>p.value.pageSize=l),"page-sizes":[10,20,50],total:p.value.total,layout:"sizes, prev, pager, next, total",background:!0,onSizeChange:L,onCurrentChange:K},null,8,["current-page","page-size","total"])]),a(B,{"model-value":k.value,"onUpdate:modelValue":e[12]||(e[12]=l=>k.value=l),title:"创建定时任务",width:"700px",onClose:x},{footer:o(()=>[a(s,{onClick:e[11]||(e[11]=l=>k.value=!1)},{default:o(()=>[...e[28]||(e[28]=[d("取消",-1)])]),_:1}),a(s,{type:"primary",onClick:N},{default:o(()=>[...e[29]||(e[29]=[d("创建",-1)])]),_:1})]),default:o(()=>[a($,{"label-width":"120px"},{default:o(()=>[a(r,{label:"任务名称",required:""},{default:o(()=>[a(y,{modelValue:n.value.name,"onUpdate:modelValue":e[4]||(e[4]=l=>n.value.name=l),placeholder:"例如：每日镜像预热"},null,8,["modelValue"])]),_:1}),a(r,{label:"Cron表达式",required:""},{default:o(()=>[a(y,{modelValue:n.value.cronExpr,"onUpdate:modelValue":e[5]||(e[5]=l=>n.value.cronExpr=l),placeholder:"0 2 * * *"},null,8,["modelValue"]),e[27]||(e[27]=V("div",{style:{"font-size":"12px",color:"#64748b","margin-top":"4px"}}," 示例：每天凌晨2点（0 2 * * *）、每小时（0 * * * *） ",-1))]),_:1}),a(r,{label:"镜像列表",required:""},{default:o(()=>[a(y,{modelValue:m.value,"onUpdate:modelValue":e[6]||(e[6]=l=>m.value=l),type:"textarea",rows:4,placeholder:"每行一个镜像地址"},null,8,["modelValue"])]),_:1}),a(r,{label:"批次大小"},{default:o(()=>[a(S,{modelValue:n.value.taskConfig.batchSize,"onUpdate:modelValue":e[7]||(e[7]=l=>n.value.taskConfig.batchSize=l),min:1,max:100},null,8,["modelValue"])]),_:1}),a(r,{label:"启用任务"},{default:o(()=>[a(D,{modelValue:n.value.enabled,"onUpdate:modelValue":e[8]||(e[8]=l=>n.value.enabled=l)},null,8,["modelValue"])]),_:1}),a(r,{label:"重叠策略"},{default:o(()=>[a(T,{modelValue:n.value.overlapPolicy,"onUpdate:modelValue":e[9]||(e[9]=l=>n.value.overlapPolicy=l)},{default:o(()=>[a(z,{label:"跳过（不执行）",value:"skip"}),a(z,{label:"允许（排队）",value:"allow"})]),_:1},8,["modelValue"])]),_:1}),a(r,{label:"超时时间（秒）"},{default:o(()=>[a(S,{modelValue:n.value.timeoutSeconds,"onUpdate:modelValue":e[10]||(e[10]=l=>n.value.timeoutSeconds=l),min:0},null,8,["modelValue"])]),_:1})]),_:1})]),_:1},8,["model-value"]),a(B,{"model-value":_.value,"onUpdate:modelValue":e[21]||(e[21]=l=>_.value=l),title:"编辑定时任务",width:"700px",onClose:x},{footer:o(()=>[a(s,{onClick:e[20]||(e[20]=l=>_.value=!1)},{default:o(()=>[...e[31]||(e[31]=[d("取消",-1)])]),_:1}),a(s,{type:"primary",onClick:H},{default:o(()=>[...e[32]||(e[32]=[d("更新",-1)])]),_:1})]),default:o(()=>[a($,{"label-width":"120px"},{default:o(()=>[a(r,{label:"任务名称",required:""},{default:o(()=>[a(y,{modelValue:n.value.name,"onUpdate:modelValue":e[13]||(e[13]=l=>n.value.name=l),placeholder:"例如：每日镜像预热"},null,8,["modelValue"])]),_:1}),a(r,{label:"Cron表达式",required:""},{default:o(()=>[a(y,{modelValue:n.value.cronExpr,"onUpdate:modelValue":e[14]||(e[14]=l=>n.value.cronExpr=l),placeholder:"0 2 * * *"},null,8,["modelValue"]),e[30]||(e[30]=V("div",{style:{"font-size":"12px",color:"#64748b","margin-top":"4px"}}," 示例：每天凌晨2点（0 2 * * *）、每小时（0 * * * *） ",-1))]),_:1}),a(r,{label:"镜像列表",required:""},{default:o(()=>[a(y,{modelValue:m.value,"onUpdate:modelValue":e[15]||(e[15]=l=>m.value=l),type:"textarea",rows:4,placeholder:"每行一个镜像地址"},null,8,["modelValue"])]),_:1}),a(r,{label:"批次大小"},{default:o(()=>[a(S,{modelValue:n.value.taskConfig.batchSize,"onUpdate:modelValue":e[16]||(e[16]=l=>n.value.taskConfig.batchSize=l),min:1,max:100},null,8,["modelValue"])]),_:1}),a(r,{label:"启用任务"},{default:o(()=>[a(D,{modelValue:n.value.enabled,"onUpdate:modelValue":e[17]||(e[17]=l=>n.value.enabled=l)},null,8,["modelValue"])]),_:1}),a(r,{label:"重叠策略"},{default:o(()=>[a(T,{modelValue:n.value.overlapPolicy,"onUpdate:modelValue":e[18]||(e[18]=l=>n.value.overlapPolicy=l)},{default:o(()=>[a(z,{label:"跳过（不执行）",value:"skip"}),a(z,{label:"允许（排队）",value:"allow"})]),_:1},8,["modelValue"])]),_:1}),a(r,{label:"超时时间（秒）"},{default:o(()=>[a(S,{modelValue:n.value.timeoutSeconds,"onUpdate:modelValue":e[19]||(e[19]=l=>n.value.timeoutSeconds=l),min:0},null,8,["modelValue"])]),_:1})]),_:1})]),_:1},8,["model-value"])])),[[W,U.value]])}}}),ge=te(ie,[["__scopeId","data-v-114c7e35"]]);export{ge as default};
