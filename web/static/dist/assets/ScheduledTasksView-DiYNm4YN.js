import{s as p}from"./index-HqSX5ej0.js";import{d as R,A as j,H as F,I as H,a as U,b as C,f as l,w as a,r as _,E as r,i as s,J,o as E,j as d,D as g,C as K,K as L}from"./element-plus-DT46MLQ6.js";import{_ as G}from"./_plugin-vue_export-helper-DlAUqK2U.js";const O={class:"scheduled-tasks"},Q={class:"header"},W={key:0},X=R({__name:"ScheduledTasksView",setup(Y){const b=_(!1),V=_([]),c=_(!1);let y=null;const f=_(""),o=_({name:"",description:"",cronExpr:"",enabled:!0,taskConfig:{images:[],batchSize:10,priority:5,maxRetries:0,retryStrategy:"linear",retryDelay:30,webhookUrl:""},overlapPolicy:"skip",timeoutSeconds:0}),v=async()=>{try{b.value=!0;const n=await p.list({limit:50,offset:0});V.value=n.tasks}catch{r.error("加载定时任务失败")}finally{b.value=!1}},D=async()=>{try{const n=f.value.split(`
`).map(i=>i.trim()).filter(i=>i.length>0);if(n.length===0){r.warning("请至少输入一个镜像地址");return}const e={...o.value,taskConfig:{...o.value.taskConfig,images:n}};await p.create(e),r.success("定时任务创建成功"),c.value=!1,f.value="",w(),v()}catch{r.error("创建定时任务失败")}},z=async n=>{try{n.enabled?(await p.disable(n.id),r.success("定时任务已禁用")):(await p.enable(n.id),r.success("定时任务已启用")),v()}catch{r.error("操作失败")}},T=async n=>{try{await p.trigger(n.id),r.success("定时任务已触发")}catch{r.error("触发失败")}},I=async n=>{try{await L.confirm("确定要删除这个定时任务吗？","确认删除",{type:"warning"}),await p.delete(n.id),r.success("定时任务已删除"),v()}catch(e){e!=="cancel"&&r.error("删除失败")}},w=()=>{o.value={name:"",description:"",cronExpr:"",enabled:!0,taskConfig:{images:[],batchSize:10,priority:5,maxRetries:0,retryStrategy:"linear",retryDelay:30,webhookUrl:""},overlapPolicy:"skip",timeoutSeconds:0},f.value=""};return j(()=>{v(),y=window.setInterval(()=>{v()},5e3)}),F(()=>{y&&clearInterval(y)}),(n,e)=>{const i=s("el-button"),m=s("el-table-column"),A=s("el-tag"),$=s("el-table"),k=s("el-input"),u=s("el-form-item"),x=s("el-input-number"),q=s("el-switch"),h=s("el-option"),B=s("el-select"),M=s("el-form"),N=s("el-dialog"),P=J("loading");return H((E(),U("div",O,[C("div",Q,[e[11]||(e[11]=C("h2",null,"定时任务管理",-1)),l(i,{type:"primary",onClick:e[0]||(e[0]=t=>c.value=!0)},{default:a(()=>[...e[10]||(e[10]=[d("新建定时任务",-1)])]),_:1})]),l($,{data:V.value,style:{width:"100%"}},{default:a(()=>[l(m,{prop:"name",label:"任务名称",width:"200"}),l(m,{prop:"cronExpr",label:"Cron表达式",width:"150"}),l(m,{prop:"taskConfig.images",label:"镜像","min-width":"200"},{default:a(({row:t})=>[d(g(t.taskConfig.images[0])+" ",1),t.taskConfig.images.length>1?(E(),U("span",W,"+"+g(t.taskConfig.images.length-1),1)):K("",!0)]),_:1}),l(m,{prop:"enabled",label:"状态",width:"100"},{default:a(({row:t})=>[l(A,{type:t.enabled?"success":"info"},{default:a(()=>[d(g(t.enabled?"已启用":"已禁用"),1)]),_:2},1032,["type"])]),_:1}),l(m,{prop:"createdAt",label:"创建时间",width:"180"},{default:a(({row:t})=>[d(g(new Date(t.createdAt).toLocaleString()),1)]),_:1}),l(m,{label:"操作",width:"280",fixed:"right"},{default:a(({row:t})=>[l(i,{size:"small",onClick:S=>z(t)},{default:a(()=>[d(g(t.enabled?"禁用":"启用"),1)]),_:2},1032,["onClick"]),l(i,{size:"small",type:"primary",onClick:S=>T(t)},{default:a(()=>[...e[12]||(e[12]=[d(" 触发 ",-1)])]),_:1},8,["onClick"]),l(i,{size:"small",type:"danger",onClick:S=>I(t)},{default:a(()=>[...e[13]||(e[13]=[d(" 删除 ",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"]),l(N,{"model-value":c.value,"onUpdate:modelValue":e[9]||(e[9]=t=>c.value=t),title:"创建定时任务",width:"700px",onClose:w},{footer:a(()=>[l(i,{onClick:e[8]||(e[8]=t=>c.value=!1)},{default:a(()=>[...e[15]||(e[15]=[d("取消",-1)])]),_:1}),l(i,{type:"primary",onClick:D},{default:a(()=>[...e[16]||(e[16]=[d("创建",-1)])]),_:1})]),default:a(()=>[l(M,{"label-width":"120px"},{default:a(()=>[l(u,{label:"任务名称",required:""},{default:a(()=>[l(k,{modelValue:o.value.name,"onUpdate:modelValue":e[1]||(e[1]=t=>o.value.name=t),placeholder:"例如：每日镜像预热"},null,8,["modelValue"])]),_:1}),l(u,{label:"Cron表达式",required:""},{default:a(()=>[l(k,{modelValue:o.value.cronExpr,"onUpdate:modelValue":e[2]||(e[2]=t=>o.value.cronExpr=t),placeholder:"0 2 * * *"},null,8,["modelValue"]),e[14]||(e[14]=C("div",{style:{"font-size":"12px",color:"#64748b","margin-top":"4px"}}," 示例：每天凌晨2点（0 2 * * *）、每小时（0 * * * *） ",-1))]),_:1}),l(u,{label:"镜像列表",required:""},{default:a(()=>[l(k,{modelValue:f.value,"onUpdate:modelValue":e[3]||(e[3]=t=>f.value=t),type:"textarea",rows:4,placeholder:"每行一个镜像地址"},null,8,["modelValue"])]),_:1}),l(u,{label:"批次大小"},{default:a(()=>[l(x,{modelValue:o.value.taskConfig.batchSize,"onUpdate:modelValue":e[4]||(e[4]=t=>o.value.taskConfig.batchSize=t),min:1,max:100},null,8,["modelValue"])]),_:1}),l(u,{label:"启用任务"},{default:a(()=>[l(q,{modelValue:o.value.enabled,"onUpdate:modelValue":e[5]||(e[5]=t=>o.value.enabled=t)},null,8,["modelValue"])]),_:1}),l(u,{label:"重叠策略"},{default:a(()=>[l(B,{modelValue:o.value.overlapPolicy,"onUpdate:modelValue":e[6]||(e[6]=t=>o.value.overlapPolicy=t)},{default:a(()=>[l(h,{label:"跳过（不执行）",value:"skip"}),l(h,{label:"允许（排队）",value:"allow"})]),_:1},8,["modelValue"])]),_:1}),l(u,{label:"超时时间（秒）"},{default:a(()=>[l(x,{modelValue:o.value.timeoutSeconds,"onUpdate:modelValue":e[7]||(e[7]=t=>o.value.timeoutSeconds=t),min:0},null,8,["modelValue"])]),_:1})]),_:1})]),_:1},8,["model-value"])])),[[P,b.value]])}}}),te=G(X,[["__scopeId","data-v-9a28c280"]]);export{te as default};
