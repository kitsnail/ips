import{t as j,l as le,b as ae}from"./index-HqSX5ej0.js";import{d as H,c,w as e,i as r,o as u,I as P,a as C,f as t,b as p,D as n,j as s,C as b,F as z,B as R,r as g,E as I,J as Q,t as oe,A as se,H as ne}from"./element-plus-DT46MLQ6.js";import{_ as J}from"./_plugin-vue_export-helper-DlAUqK2U.js";const ie={key:0},de={style:{"font-family":"monospace",color:"#0891b2"}},ue={style:{"font-family":"monospace"}},re={style:{display:"grid","grid-template-columns":"repeat(2, 1fr)",gap:"8px"}},me={style:{"margin-top":"8px"}},fe={style:{display:"flex","align-items":"center",gap:"8px"}},ce={style:{"font-family":"monospace",color:"#0891b2","font-weight":"500"}},pe={style:{"font-family":"monospace"}},ve=H({__name:"TaskDetailModal",props:{visible:{type:Boolean},task:{}},emits:["update:visible","cancel"],setup(l,{emit:T}){const D=T,h=l,f=g(!1),M=async()=>{if(h.task)try{f.value=!0,await j.delete(h.task.taskId),I.success("任务已取消"),D("cancel")}catch{I.error("取消任务失败")}finally{f.value=!1}},S=y=>({pending:"等待中",running:"运行中",completed:"已完成",failed:"失败",cancelled:"已取消"})[y]||y,x=y=>({pending:"info",running:"warning",completed:"success",failed:"danger",cancelled:"info"})[y]||"info",w=y=>y?new Date(y).toLocaleString():"-";return(y,i)=>{const m=r("el-descriptions-item"),v=r("el-tag"),N=r("el-descriptions"),k=r("el-divider"),A=r("el-scrollbar"),$=r("el-alert"),U=r("el-table-column"),d=r("el-table"),a=r("el-button"),B=r("el-dialog"),q=Q("loading");return u(),c(B,{"model-value":l.visible,"onUpdate:modelValue":i[1]||(i[1]=V=>D("update:visible",V)),title:"任务详情",width:"900px"},{footer:e(()=>[t(a,{onClick:i[0]||(i[0]=V=>D("update:visible",!1))},{default:e(()=>[...i[10]||(i[10]=[s("关闭",-1)])]),_:1}),l.task&&(l.task.status==="pending"||l.task.status==="running")?(u(),c(a,{key:0,type:"danger",loading:f.value,onClick:M},{default:e(()=>[...i[11]||(i[11]=[s(" 取消任务 ",-1)])]),_:1},8,["loading"])):b("",!0)]),default:e(()=>[l.task?P((u(),C("div",ie,[t(N,{column:2,border:""},{default:e(()=>[t(m,{label:"任务ID"},{default:e(()=>[p("span",de,n(l.task.taskId),1)]),_:1}),t(m,{label:"状态"},{default:e(()=>[t(v,{type:x(l.task.status)},{default:e(()=>[s(n(S(l.task.status)),1)]),_:1},8,["type"])]),_:1}),t(m,{label:"优先级"},{default:e(()=>[s(n(l.task.priority),1)]),_:1}),t(m,{label:"批次大小"},{default:e(()=>[s(n(l.task.batchSize),1)]),_:1}),t(m,{label:"创建时间"},{default:e(()=>[s(n(w(l.task.createdAt)),1)]),_:1}),l.task.startedAt?(u(),c(m,{key:0,label:"开始时间"},{default:e(()=>[s(n(w(l.task.startedAt)),1)]),_:1})):b("",!0),l.task.finishedAt?(u(),c(m,{key:1,label:"完成时间"},{default:e(()=>[s(n(w(l.task.finishedAt)),1)]),_:1})):b("",!0),t(m,{label:"重试次数"},{default:e(()=>[s(n(l.task.retryCount)+" / "+n(l.task.maxRetries),1)]),_:1}),t(m,{label:"重试策略"},{default:e(()=>[s(n(l.task.retryStrategy==="linear"?"线性":"指数退避"),1)]),_:1}),l.task.retryDelay?(u(),c(m,{key:2,label:"重试延迟"},{default:e(()=>[s(n(l.task.retryDelay)+" 秒 ",1)]),_:1})):b("",!0),l.task.webhookUrl?(u(),c(m,{key:3,label:"Webhook URL"},{default:e(()=>[p("span",ue,n(l.task.webhookUrl),1)]),_:1})):b("",!0)]),_:1}),t(k,{"content-position":"left"},{default:e(()=>[...i[2]||(i[2]=[s("进度",-1)])]),_:1}),l.task.progress?(u(),c(N,{key:0,column:3,border:""},{default:e(()=>[t(m,{label:"总节点数"},{default:e(()=>[s(n(l.task.progress.totalNodes),1)]),_:1}),t(m,{label:"已完成"},{default:e(()=>[s(n(l.task.progress.completedNodes),1)]),_:1}),t(m,{label:"失败"},{default:e(()=>[s(n(l.task.progress.failedNodes),1)]),_:1}),t(m,{label:"当前批次"},{default:e(()=>[s(n(l.task.progress.currentBatch)+" / "+n(l.task.progress.totalBatches),1)]),_:1}),t(m,{label:"完成率"},{default:e(()=>[s(n(l.task.progress.percentage.toFixed(1))+"% ",1)]),_:1})]),_:1})):b("",!0),t(k,{"content-position":"left"},{default:e(()=>[...i[3]||(i[3]=[s("镜像列表",-1)])]),_:1}),t(A,{"max-height":"200px"},{default:e(()=>[p("div",re,[(u(!0),C(z,null,R(l.task.images,(V,_)=>(u(),c(v,{key:_,style:{"font-family":"monospace","font-size":"13px"}},{default:e(()=>[s(n(V),1)]),_:2},1024))),128))])]),_:1}),l.task.secretName?(u(),c(k,{key:1,"content-position":"left"},{default:e(()=>[...i[4]||(i[4]=[s("私有仓库认证",-1)])]),_:1})):b("",!0),l.task.secretName?(u(),c($,{key:2,type:"info",closable:!1,style:{"margin-bottom":"24px"}},{title:e(()=>[...i[5]||(i[5]=[p("span",{style:{"font-weight":"600"}},"已启用私有仓库认证",-1)])]),default:e(()=>[p("div",me,[p("div",fe,[i[6]||(i[6]=p("span",null,"Secret 名称：",-1)),p("span",ce,n(l.task.secretName),1)]),i[7]||(i[7]=p("div",{style:{"font-size":"12px",color:"#64748b","margin-top":"4px"}}," 临时 Secret 会在任务完成后自动清理 ",-1))])]),_:1})):b("",!0),l.task.errorMessage?(u(),c(k,{key:3,"content-position":"left"},{default:e(()=>[...i[8]||(i[8]=[s("错误信息",-1)])]),_:1})):b("",!0),l.task.errorMessage?(u(),c($,{key:4,type:"error",closable:!1},{default:e(()=>[s(n(l.task.errorMessage),1)]),_:1})):b("",!0),l.task.failedNodeDetails&&l.task.failedNodeDetails.length>0?(u(),c(k,{key:5,"content-position":"left"},{default:e(()=>[...i[9]||(i[9]=[s("失败节点详情",-1)])]),_:1})):b("",!0),l.task.failedNodeDetails&&l.task.failedNodeDetails.length>0?(u(),c(d,{key:6,data:l.task.failedNodeDetails,style:{width:"100%","margin-top":"8px"},"max-height":"200px"},{default:e(()=>[t(U,{prop:"nodeName",label:"节点名称",width:"200"}),t(U,{prop:"image",label:"镜像","min-width":"250"},{default:e(({row:V})=>[p("span",pe,n(V.image),1)]),_:1}),t(U,{prop:"reason",label:"原因",width:"120"}),t(U,{prop:"message",label:"消息"},{default:e(({row:V})=>[s(n(V.message||"-"),1)]),_:1}),t(U,{prop:"timestamp",label:"时间",width:"180"},{default:e(({row:V})=>[s(n(new Date(V.timestamp).toLocaleString()),1)]),_:1})]),_:1},8,["data"])):b("",!0)])),[[q,f.value]]):b("",!0)]),_:1},8,["model-value"])}}}),be=J(ve,[["__scopeId","data-v-de8617c9"]]),ge={class:"image-picker"},ye={class:"image-item"},ke={class:"image-name"},_e={class:"image-url"},we={key:0,class:"loading-text"},xe={class:"selected-images"},Ve={style:{float:"left"}},he={style:{float:"right",color:"#8492a6","font-size":"12px"}},Ce=H({__name:"CreateTaskModal",props:{visible:{type:Boolean}},emits:["update:visible","success"],setup(l,{expose:T,emit:D}){const h=D,f=g({images:[],batchSize:10,priority:5,maxRetries:0,retryStrategy:"linear",retryDelay:30,nodeSelector:{}}),M=g(!1),S=g("manual"),x=g([]),w=g([]),y=g([]),i=g(!1),m=g(!1),v=g(!1),N=async()=>{try{m.value=!0;const d=await le.list({limit:100});w.value=d.images}catch{I.error("加载镜像库失败")}finally{m.value=!1}},k=async()=>{try{v.value=!0;const d=await ae.list({pageSize:100});y.value=d.secrets}catch{I.error("加载认证信息失败")}finally{v.value=!1}},A=()=>{N(),k()},$=()=>{h("update:visible",!1)},U=async()=>{try{const d=x.value.map(a=>w.value.find(B=>B.id===a)?.image).filter(a=>!!a);if(d.length===0){I.warning("请至少选择一个镜像");return}f.value.images=d,i.value=!0,await j.create(f.value),I.success("任务创建成功"),h("success"),$()}catch(d){I.error(d.response?.data?.error||"创建任务失败")}finally{i.value=!1}};return T({handleOpen:A}),(d,a)=>{const B=r("el-checkbox"),q=r("el-empty"),V=r("el-checkbox-group"),_=r("el-form-item"),X=r("el-tag"),F=r("el-input-number"),Y=r("el-switch"),W=r("el-radio"),Z=r("el-radio-group"),O=r("el-input"),E=r("el-option"),G=r("el-select"),ee=r("el-form"),K=r("el-button"),te=r("el-dialog");return u(),c(te,{"model-value":l.visible,"onUpdate:modelValue":a[11]||(a[11]=o=>h("update:visible",o)),title:"创建镜像预热任务",width:"800px",onOpen:A},{footer:e(()=>[t(K,{onClick:$},{default:e(()=>[...a[14]||(a[14]=[s("取消",-1)])]),_:1}),t(K,{type:"primary",onClick:U,loading:i.value},{default:e(()=>[...a[15]||(a[15]=[s(" 创建任务 ",-1)])]),_:1},8,["loading"])]),default:e(()=>[t(ee,{"label-width":"120px"},{default:e(()=>[t(_,{label:"镜像列表"},{default:e(()=>[t(V,{modelValue:x.value,"onUpdate:modelValue":a[0]||(a[0]=o=>x.value=o)},{default:e(()=>[p("div",ge,[(u(!0),C(z,null,R(w.value,o=>(u(),c(B,{key:o.id,label:o.id,border:""},{default:e(()=>[p("div",ye,[p("div",ke,n(o.name),1),p("div",_e,n(o.image),1)])]),_:2},1032,["label"]))),128))]),m.value?(u(),C("div",we,"加载中...")):w.value.length===0?(u(),c(q,{key:1,description:"暂无镜像","image-size":80})):b("",!0)]),_:1},8,["modelValue"])]),_:1}),t(_,{label:"已选镜像"},{default:e(()=>[p("div",xe,[(u(!0),C(z,null,R(x.value,o=>(u(),c(X,{key:o,closable:"",onClose:()=>{const L=x.value.indexOf(o);L>-1&&x.value.splice(L,1)}},{default:e(()=>[s(n(w.value.find(L=>L.id===o)?.name),1)]),_:2},1032,["onClose"]))),128))])]),_:1}),t(_,{label:"批次大小"},{default:e(()=>[t(F,{modelValue:f.value.batchSize,"onUpdate:modelValue":a[1]||(a[1]=o=>f.value.batchSize=o),min:1,max:100},null,8,["modelValue"])]),_:1}),t(_,{label:"优先级"},{default:e(()=>[t(F,{modelValue:f.value.priority,"onUpdate:modelValue":a[2]||(a[2]=o=>f.value.priority=o),min:1,max:10},null,8,["modelValue"])]),_:1}),t(_,{label:"私有仓库"},{default:e(()=>[t(Y,{modelValue:M.value,"onUpdate:modelValue":a[3]||(a[3]=o=>M.value=o)},null,8,["modelValue"])]),_:1}),M.value?(u(),C(z,{key:0},[t(_,{label:"认证方式"},{default:e(()=>[t(Z,{modelValue:S.value,"onUpdate:modelValue":a[4]||(a[4]=o=>S.value=o)},{default:e(()=>[t(W,{value:"manual"},{default:e(()=>[...a[12]||(a[12]=[s("手动输入",-1)])]),_:1}),t(W,{value:"select"},{default:e(()=>[...a[13]||(a[13]=[s("选择已保存",-1)])]),_:1})]),_:1},8,["modelValue"])]),_:1}),S.value==="manual"?(u(),C(z,{key:0},[t(_,{label:"仓库地址",required:""},{default:e(()=>[t(O,{modelValue:f.value.registry,"onUpdate:modelValue":a[5]||(a[5]=o=>f.value.registry=o),placeholder:"harbor.example.com"},null,8,["modelValue"])]),_:1}),t(_,{label:"用户名",required:""},{default:e(()=>[t(O,{modelValue:f.value.username,"onUpdate:modelValue":a[6]||(a[6]=o=>f.value.username=o)},null,8,["modelValue"])]),_:1}),t(_,{label:"密码",required:""},{default:e(()=>[t(O,{modelValue:f.value.password,"onUpdate:modelValue":a[7]||(a[7]=o=>f.value.password=o),type:"password","show-password":""},null,8,["modelValue"])]),_:1})],64)):b("",!0),S.value==="select"?(u(),c(_,{key:1,label:"选择认证",required:""},{default:e(()=>[t(G,{modelValue:f.value.secretId,"onUpdate:modelValue":a[8]||(a[8]=o=>f.value.secretId=o),placeholder:"请选择认证",style:{width:"100%"}},{default:e(()=>[(u(!0),C(z,null,R(y.value,o=>(u(),c(E,{key:o.id,label:o.name,value:o.id},{default:e(()=>[p("span",Ve,n(o.name),1),p("span",he,n(o.registry),1)]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})):b("",!0)],64)):b("",!0),t(_,{label:"最大重试"},{default:e(()=>[t(F,{modelValue:f.value.maxRetries,"onUpdate:modelValue":a[9]||(a[9]=o=>f.value.maxRetries=o),min:0,max:5},null,8,["modelValue"])]),_:1}),t(_,{label:"重试策略"},{default:e(()=>[t(G,{modelValue:f.value.retryStrategy,"onUpdate:modelValue":a[10]||(a[10]=o=>f.value.retryStrategy=o)},{default:e(()=>[t(E,{label:"线性",value:"linear"}),t(E,{label:"指数退避",value:"exponential"})]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1},8,["model-value"])}}}),De=J(Ce,[["__scopeId","data-v-d58957dc"]]),Se={class:"tasks"},Ue={class:"header"},Me={key:0},Ie=H({__name:"TasksView",setup(l){const T=g([]),D=g(!1),h=g(!1),f=g(!1),M=g(null),S=g(null);let x=null;const w=async()=>{try{D.value=!0;const m=await j.list({limit:10,offset:0});T.value=m.tasks}catch{I.error("加载任务失败")}finally{D.value=!1}},y=()=>{w()};oe(h,m=>{m&&S.value&&S.value.handleOpen()});const i=m=>{M.value=m,f.value=!0};return se(()=>{w(),x=window.setInterval(()=>{w()},5e3)}),ne(()=>{x&&clearInterval(x)}),(m,v)=>{const N=r("el-button"),k=r("el-table-column"),A=r("el-tag"),$=r("el-table"),U=Q("loading");return u(),C("div",Se,[p("div",Ue,[v[4]||(v[4]=p("h2",null,"任务管理",-1)),t(N,{type:"primary",onClick:v[0]||(v[0]=d=>h.value=!0)},{default:e(()=>[...v[3]||(v[3]=[s("新建任务",-1)])]),_:1})]),P((u(),c($,{data:T.value,style:{width:"100%"}},{default:e(()=>[t(k,{prop:"taskId",label:"任务ID",width:"180"}),t(k,{prop:"status",label:"状态",width:"100"},{default:e(({row:d})=>[t(A,{type:d.status==="completed"?"success":d.status==="failed"?"danger":"info"},{default:e(()=>[s(n(d.status),1)]),_:2},1032,["type"])]),_:1}),t(k,{prop:"images",label:"镜像"},{default:e(({row:d})=>[s(n(d.images[0])+" ",1),d.images.length>1?(u(),C("span",Me,"+"+n(d.images.length-1),1)):b("",!0)]),_:1}),t(k,{prop:"progress.percentage",label:"进度",width:"120"},{default:e(({row:d})=>[s(n(d.progress?.percentage?.toFixed(1)||0)+"% ",1)]),_:1}),t(k,{prop:"createdAt",label:"创建时间",width:"180"},{default:e(({row:d})=>[s(n(new Date(d.createdAt).toLocaleString()),1)]),_:1}),t(k,{label:"操作",width:"150"},{default:e(({row:d})=>[t(N,{size:"small",onClick:a=>i(d)},{default:e(()=>[...v[5]||(v[5]=[s("详情",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[U,D.value]]),t(De,{visible:h.value,"onUpdate:visible":v[1]||(v[1]=d=>h.value=d),onSuccess:y},null,8,["visible"]),t(be,{visible:f.value,task:M.value,"onUpdate:visible":v[2]||(v[2]=d=>f.value=d)},null,8,["visible","task"])])}}}),Ae=J(Ie,[["__scopeId","data-v-910ee9c7"]]);export{Ae as default};
