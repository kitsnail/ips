import{t as U}from"./index-D5L2XjAQ.js";import{d as V,f as r,l as e,q as u,t as d,I as $,g as S,k as a,j as c,C as o,v as s,B as f,F as j,A as q,r as x,E as B,J as L,G,H}from"./element-plus-D4iBZxCD.js";import{_ as z}from"./_plugin-vue_export-helper-DlAUqK2U.js";const J={key:0},W={style:{"font-family":"monospace",color:"#0891b2"}},K={style:{"font-family":"monospace"}},O={style:{display:"grid","grid-template-columns":"repeat(2, 1fr)",gap:"8px"}},P={style:{"margin-top":"8px"}},Q={style:{display:"flex","align-items":"center",gap:"8px"}},X={style:{"font-family":"monospace",color:"#0891b2","font-weight":"500"}},Y={style:{"font-family":"monospace"}},Z=V({__name:"TaskDetailModal",props:{visible:{type:Boolean},task:{}},emits:["update:visible","cancel"],setup(t,{emit:N}){const y=N,w=t,b=x(!1),M=async()=>{if(w.task)try{b.value=!0,await U.delete(w.task.taskId),B.success("任务已取消"),y("cancel")}catch{B.error("取消任务失败")}finally{b.value=!1}},h=m=>({pending:"等待中",running:"运行中",completed:"已完成",failed:"失败",cancelled:"已取消"})[m]||m,_=m=>({pending:"info",running:"warning",completed:"success",failed:"danger",cancelled:"info"})[m]||"info",D=m=>m?new Date(m).toLocaleString():"-";return(m,l)=>{const n=u("el-descriptions-item"),C=u("el-tag"),g=u("el-descriptions"),p=u("el-divider"),I=u("el-scrollbar"),T=u("el-alert"),v=u("el-table-column"),i=u("el-table"),A=u("el-button"),F=u("el-dialog"),E=L("loading");return d(),r(F,{"model-value":t.visible,"onUpdate:modelValue":l[1]||(l[1]=k=>y("update:visible",k)),title:"任务详情",width:"900px"},{footer:e(()=>[a(A,{onClick:l[0]||(l[0]=k=>y("update:visible",!1))},{default:e(()=>[...l[10]||(l[10]=[s("关闭",-1)])]),_:1}),t.task&&(t.task.status==="pending"||t.task.status==="running")?(d(),r(A,{key:0,type:"danger",loading:b.value,onClick:M},{default:e(()=>[...l[11]||(l[11]=[s(" 取消任务 ",-1)])]),_:1},8,["loading"])):f("",!0)]),default:e(()=>[t.task?$((d(),S("div",J,[a(g,{column:2,border:""},{default:e(()=>[a(n,{label:"任务ID"},{default:e(()=>[c("span",W,o(t.task.taskId),1)]),_:1}),a(n,{label:"状态"},{default:e(()=>[a(C,{type:_(t.task.status)},{default:e(()=>[s(o(h(t.task.status)),1)]),_:1},8,["type"])]),_:1}),a(n,{label:"优先级"},{default:e(()=>[s(o(t.task.priority),1)]),_:1}),a(n,{label:"批次大小"},{default:e(()=>[s(o(t.task.batchSize),1)]),_:1}),a(n,{label:"创建时间"},{default:e(()=>[s(o(D(t.task.createdAt)),1)]),_:1}),t.task.startedAt?(d(),r(n,{key:0,label:"开始时间"},{default:e(()=>[s(o(D(t.task.startedAt)),1)]),_:1})):f("",!0),t.task.finishedAt?(d(),r(n,{key:1,label:"完成时间"},{default:e(()=>[s(o(D(t.task.finishedAt)),1)]),_:1})):f("",!0),a(n,{label:"重试次数"},{default:e(()=>[s(o(t.task.retryCount)+" / "+o(t.task.maxRetries),1)]),_:1}),a(n,{label:"重试策略"},{default:e(()=>[s(o(t.task.retryStrategy==="linear"?"线性":"指数退避"),1)]),_:1}),t.task.retryDelay?(d(),r(n,{key:2,label:"重试延迟"},{default:e(()=>[s(o(t.task.retryDelay)+" 秒 ",1)]),_:1})):f("",!0),t.task.webhookUrl?(d(),r(n,{key:3,label:"Webhook URL"},{default:e(()=>[c("span",K,o(t.task.webhookUrl),1)]),_:1})):f("",!0)]),_:1}),a(p,{"content-position":"left"},{default:e(()=>[...l[2]||(l[2]=[s("进度",-1)])]),_:1}),t.task.progress?(d(),r(g,{key:0,column:3,border:""},{default:e(()=>[a(n,{label:"总节点数"},{default:e(()=>[s(o(t.task.progress.totalNodes),1)]),_:1}),a(n,{label:"已完成"},{default:e(()=>[s(o(t.task.progress.completedNodes),1)]),_:1}),a(n,{label:"失败"},{default:e(()=>[s(o(t.task.progress.failedNodes),1)]),_:1}),a(n,{label:"当前批次"},{default:e(()=>[s(o(t.task.progress.currentBatch)+" / "+o(t.task.progress.totalBatches),1)]),_:1}),a(n,{label:"完成率"},{default:e(()=>[s(o(t.task.progress.percentage.toFixed(1))+"% ",1)]),_:1})]),_:1})):f("",!0),a(p,{"content-position":"left"},{default:e(()=>[...l[3]||(l[3]=[s("镜像列表",-1)])]),_:1}),a(I,{"max-height":"200px"},{default:e(()=>[c("div",O,[(d(!0),S(j,null,q(t.task.images,(k,R)=>(d(),r(C,{key:R,style:{"font-family":"monospace","font-size":"13px"}},{default:e(()=>[s(o(k),1)]),_:2},1024))),128))])]),_:1}),t.task.secretName?(d(),r(p,{key:1,"content-position":"left"},{default:e(()=>[...l[4]||(l[4]=[s("私有仓库认证",-1)])]),_:1})):f("",!0),t.task.secretName?(d(),r(T,{key:2,type:"info",closable:!1,style:{"margin-bottom":"24px"}},{title:e(()=>[...l[5]||(l[5]=[c("span",{style:{"font-weight":"600"}},"已启用私有仓库认证",-1)])]),default:e(()=>[c("div",P,[c("div",Q,[l[6]||(l[6]=c("span",null,"Secret 名称：",-1)),c("span",X,o(t.task.secretName),1)]),l[7]||(l[7]=c("div",{style:{"font-size":"12px",color:"#64748b","margin-top":"4px"}}," 临时 Secret 会在任务完成后自动清理 ",-1))])]),_:1})):f("",!0),t.task.errorMessage?(d(),r(p,{key:3,"content-position":"left"},{default:e(()=>[...l[8]||(l[8]=[s("错误信息",-1)])]),_:1})):f("",!0),t.task.errorMessage?(d(),r(T,{key:4,type:"error",closable:!1},{default:e(()=>[s(o(t.task.errorMessage),1)]),_:1})):f("",!0),t.task.failedNodeDetails&&t.task.failedNodeDetails.length>0?(d(),r(p,{key:5,"content-position":"left"},{default:e(()=>[...l[9]||(l[9]=[s("失败节点详情",-1)])]),_:1})):f("",!0),t.task.failedNodeDetails&&t.task.failedNodeDetails.length>0?(d(),r(i,{key:6,data:t.task.failedNodeDetails,style:{width:"100%","margin-top":"8px"},"max-height":"200px"},{default:e(()=>[a(v,{prop:"nodeName",label:"节点名称",width:"200"}),a(v,{prop:"image",label:"镜像","min-width":"250"},{default:e(({row:k})=>[c("span",Y,o(k.image),1)]),_:1}),a(v,{prop:"reason",label:"原因",width:"120"}),a(v,{prop:"message",label:"消息"},{default:e(({row:k})=>[s(o(k.message||"-"),1)]),_:1}),a(v,{prop:"timestamp",label:"时间",width:"180"},{default:e(({row:k})=>[s(o(new Date(k.timestamp).toLocaleString()),1)]),_:1})]),_:1},8,["data"])):f("",!0)])),[[E,b.value]]):f("",!0)]),_:1},8,["model-value"])}}}),ee=z(Z,[["__scopeId","data-v-de8617c9"]]),te={class:"tasks"},ae={class:"header"},le={key:0},se=V({__name:"TasksView",setup(t){const N=x([]),y=x(!1),w=x(!1),b=x(!1),M=x(null);let h=null;const _=async()=>{try{y.value=!0;const l=await U.list({limit:10,offset:0});N.value=l.tasks}catch{B.error("加载任务失败")}finally{y.value=!1}},D=()=>{_()},m=l=>{M.value=l,b.value=!0};return G(()=>{_(),h=window.setInterval(()=>{_()},5e3)}),H(()=>{h&&clearInterval(h)}),(l,n)=>{const C=u("el-button"),g=u("el-table-column"),p=u("el-tag"),I=u("el-table"),T=u("CreateTaskModal"),v=L("loading");return d(),S("div",te,[c("div",ae,[n[4]||(n[4]=c("h2",null,"任务管理",-1)),a(C,{type:"primary",onClick:n[0]||(n[0]=i=>w.value=!0)},{default:e(()=>[...n[3]||(n[3]=[s("新建任务",-1)])]),_:1})]),$((d(),r(I,{data:N.value,style:{width:"100%"}},{default:e(()=>[a(g,{prop:"taskId",label:"任务ID",width:"180"}),a(g,{prop:"status",label:"状态",width:"100"},{default:e(({row:i})=>[a(p,{type:i.status==="completed"?"success":i.status==="failed"?"danger":"info"},{default:e(()=>[s(o(i.status),1)]),_:2},1032,["type"])]),_:1}),a(g,{prop:"images",label:"镜像"},{default:e(({row:i})=>[s(o(i.images[0])+" ",1),i.images.length>1?(d(),S("span",le,"+"+o(i.images.length-1),1)):f("",!0)]),_:1}),a(g,{prop:"progress.percentage",label:"进度",width:"120"},{default:e(({row:i})=>[s(o(i.progress?.percentage?.toFixed(1)||0)+"% ",1)]),_:1}),a(g,{prop:"createdAt",label:"创建时间",width:"180"},{default:e(({row:i})=>[s(o(new Date(i.createdAt).toLocaleString()),1)]),_:1}),a(g,{label:"操作",width:"150"},{default:e(({row:i})=>[a(C,{size:"small",onClick:A=>m(i)},{default:e(()=>[...n[5]||(n[5]=[s("详情",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[v,y.value]]),a(T,{visible:w.value,"onUpdate:visible":n[1]||(n[1]=i=>w.value=i),onSuccess:D},null,8,["visible"]),a(ee,{visible:b.value,task:M.value,"onUpdate:visible":n[2]||(n[2]=i=>b.value=i)},null,8,["visible","task"])])}}}),de=z(se,[["__scopeId","data-v-e2ab1bf1"]]);export{de as default};
