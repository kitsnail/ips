import{t as P,l as ae,b as oe}from"./index-azKvCBLj.js";import{d as H,c as v,w as e,i as u,o as d,I as X,a as D,f as t,b as y,D as i,j as n,C as k,F as L,B as F,r as x,E as S,J as Y,t as se,A as ne,H as ie,K as Q}from"./element-plus-DT46MLQ6.js";import{_ as J}from"./_plugin-vue_export-helper-DlAUqK2U.js";const re={key:0},de={style:{"font-family":"monospace",color:"#0891b2"}},ue={style:{"font-family":"monospace"}},me={style:{display:"grid","grid-template-columns":"repeat(2, 1fr)",gap:"8px"}},ce={style:{"margin-top":"8px"}},fe={style:{display:"flex","align-items":"center",gap:"8px"}},pe={style:{"font-family":"monospace",color:"#0891b2","font-weight":"500"}},ge={style:{"font-family":"monospace"}},ve=H({__name:"TaskDetailModal",props:{visible:{type:Boolean},task:{}},emits:["update:visible","cancel"],setup(a,{emit:N}){const $=N,C=a,m=x(!1),M=async()=>{if(C.task)try{m.value=!0,await P.delete(C.task.taskId),S.success("任务已取消"),$("cancel")}catch{S.error("取消任务失败")}finally{m.value=!1}},V=b=>({pending:"等待中",running:"运行中",completed:"已完成",failed:"失败",cancelled:"已取消"})[b]||b,z=b=>({pending:"info",running:"warning",completed:"success",failed:"danger",cancelled:"info"})[b]||"info",p=b=>b?new Date(b).toLocaleString():"-";return(b,r)=>{const g=u("el-descriptions-item"),T=u("el-tag"),I=u("el-descriptions"),U=u("el-divider"),A=u("el-scrollbar"),c=u("el-alert"),o=u("el-table-column"),_=u("el-table"),l=u("el-button"),B=u("el-dialog"),R=Y("loading");return d(),v(B,{"model-value":a.visible,"onUpdate:modelValue":r[1]||(r[1]=h=>$("update:visible",h)),title:"任务详情",width:"900px"},{footer:e(()=>[t(l,{onClick:r[0]||(r[0]=h=>$("update:visible",!1))},{default:e(()=>[...r[10]||(r[10]=[n("关闭",-1)])]),_:1}),a.task&&(a.task.status==="pending"||a.task.status==="running")?(d(),v(l,{key:0,type:"danger",loading:m.value,onClick:M},{default:e(()=>[...r[11]||(r[11]=[n(" 取消任务 ",-1)])]),_:1},8,["loading"])):k("",!0)]),default:e(()=>[a.task?X((d(),D("div",re,[t(I,{column:2,border:""},{default:e(()=>[t(g,{label:"任务ID"},{default:e(()=>[y("span",de,i(a.task.taskId),1)]),_:1}),t(g,{label:"状态"},{default:e(()=>[t(T,{type:z(a.task.status)},{default:e(()=>[n(i(V(a.task.status)),1)]),_:1},8,["type"])]),_:1}),t(g,{label:"优先级"},{default:e(()=>[n(i(a.task.priority),1)]),_:1}),t(g,{label:"批次大小"},{default:e(()=>[n(i(a.task.batchSize),1)]),_:1}),t(g,{label:"创建时间"},{default:e(()=>[n(i(p(a.task.createdAt)),1)]),_:1}),a.task.startedAt?(d(),v(g,{key:0,label:"开始时间"},{default:e(()=>[n(i(p(a.task.startedAt)),1)]),_:1})):k("",!0),a.task.finishedAt?(d(),v(g,{key:1,label:"完成时间"},{default:e(()=>[n(i(p(a.task.finishedAt)),1)]),_:1})):k("",!0),t(g,{label:"重试次数"},{default:e(()=>[n(i(a.task.retryCount)+" / "+i(a.task.maxRetries),1)]),_:1}),t(g,{label:"重试策略"},{default:e(()=>[n(i(a.task.retryStrategy==="linear"?"线性":"指数退避"),1)]),_:1}),a.task.retryDelay?(d(),v(g,{key:2,label:"重试延迟"},{default:e(()=>[n(i(a.task.retryDelay)+" 秒 ",1)]),_:1})):k("",!0),a.task.webhookUrl?(d(),v(g,{key:3,label:"Webhook URL"},{default:e(()=>[y("span",ue,i(a.task.webhookUrl),1)]),_:1})):k("",!0)]),_:1}),t(U,{"content-position":"left"},{default:e(()=>[...r[2]||(r[2]=[n("进度",-1)])]),_:1}),a.task.progress?(d(),v(I,{key:0,column:3,border:""},{default:e(()=>[t(g,{label:"总节点数"},{default:e(()=>[n(i(a.task.progress.totalNodes),1)]),_:1}),t(g,{label:"已完成"},{default:e(()=>[n(i(a.task.progress.completedNodes),1)]),_:1}),t(g,{label:"失败"},{default:e(()=>[n(i(a.task.progress.failedNodes),1)]),_:1}),t(g,{label:"当前批次"},{default:e(()=>[n(i(a.task.progress.currentBatch)+" / "+i(a.task.progress.totalBatches),1)]),_:1}),t(g,{label:"完成率"},{default:e(()=>[n(i(a.task.progress.percentage.toFixed(1))+"% ",1)]),_:1})]),_:1})):k("",!0),t(U,{"content-position":"left"},{default:e(()=>[...r[3]||(r[3]=[n("镜像列表",-1)])]),_:1}),t(A,{"max-height":"200px"},{default:e(()=>[y("div",me,[(d(!0),D(L,null,F(a.task.images,(h,w)=>(d(),v(T,{key:w,style:{"font-family":"monospace","font-size":"13px"}},{default:e(()=>[n(i(h),1)]),_:2},1024))),128))])]),_:1}),a.task.secretName?(d(),v(U,{key:1,"content-position":"left"},{default:e(()=>[...r[4]||(r[4]=[n("私有仓库认证",-1)])]),_:1})):k("",!0),a.task.secretName?(d(),v(c,{key:2,type:"info",closable:!1,style:{"margin-bottom":"24px"}},{title:e(()=>[...r[5]||(r[5]=[y("span",{style:{"font-weight":"600"}},"已启用私有仓库认证",-1)])]),default:e(()=>[y("div",ce,[y("div",fe,[r[6]||(r[6]=y("span",null,"Secret 名称：",-1)),y("span",pe,i(a.task.secretName),1)]),r[7]||(r[7]=y("div",{style:{"font-size":"12px",color:"#64748b","margin-top":"4px"}}," 临时 Secret 会在任务完成后自动清理 ",-1))])]),_:1})):k("",!0),a.task.errorMessage?(d(),v(U,{key:3,"content-position":"left"},{default:e(()=>[...r[8]||(r[8]=[n("错误信息",-1)])]),_:1})):k("",!0),a.task.errorMessage?(d(),v(c,{key:4,type:"error",closable:!1},{default:e(()=>[n(i(a.task.errorMessage),1)]),_:1})):k("",!0),a.task.failedNodeDetails&&a.task.failedNodeDetails.length>0?(d(),v(U,{key:5,"content-position":"left"},{default:e(()=>[...r[9]||(r[9]=[n("失败节点详情",-1)])]),_:1})):k("",!0),a.task.failedNodeDetails&&a.task.failedNodeDetails.length>0?(d(),v(_,{key:6,data:a.task.failedNodeDetails,style:{width:"100%","margin-top":"8px"},"max-height":"200px"},{default:e(()=>[t(o,{prop:"nodeName",label:"节点名称",width:"200"}),t(o,{prop:"image",label:"镜像","min-width":"250"},{default:e(({row:h})=>[y("span",ge,i(h.image),1)]),_:1}),t(o,{prop:"reason",label:"原因",width:"120"}),t(o,{prop:"message",label:"消息"},{default:e(({row:h})=>[n(i(h.message||"-"),1)]),_:1}),t(o,{prop:"timestamp",label:"时间",width:"180"},{default:e(({row:h})=>[n(i(new Date(h.timestamp).toLocaleString()),1)]),_:1})]),_:1},8,["data"])):k("",!0)])),[[R,m.value]]):k("",!0)]),_:1},8,["model-value"])}}}),ye=J(ve,[["__scopeId","data-v-de8617c9"]]),be={class:"image-picker"},ke={class:"image-item"},_e={class:"image-name"},xe={class:"image-url"},we={key:0,class:"loading-text"},Ve={class:"selected-images"},he={style:{float:"left"}},Se={style:{float:"right",color:"#8492a6","font-size":"12px"}},Ce=H({__name:"CreateTaskModal",props:{visible:{type:Boolean}},emits:["update:visible","success"],setup(a,{expose:N,emit:$}){const C=$,m=x({images:[],batchSize:10,priority:5,maxRetries:0,retryStrategy:"linear",retryDelay:30,nodeSelector:{}}),M=x(!1),V=x("manual"),z=x([]),p=x([]),b=x([]),r=x(!1),g=x(!1),T=x(!1),I=async()=>{try{g.value=!0;const _=await ae.list({limit:100});p.value=_.images}catch{S.error("加载镜像库失败")}finally{g.value=!1}},U=async()=>{try{T.value=!0;const _=await oe.list({pageSize:100});b.value=_.secrets}catch{S.error("加载认证信息失败")}finally{T.value=!1}},A=()=>{I(),U()},c=()=>{C("update:visible",!1)},o=async()=>{try{const _=z.value.map(l=>p.value.find(B=>B.id===l)?.image).filter(l=>!!l);if(_.length===0){S.warning("请至少选择一个镜像");return}m.value.images=_,r.value=!0,await P.create(m.value),S.success("任务创建成功"),C("success"),c()}catch(_){S.error(_.response?.data?.error||"创建任务失败")}finally{r.value=!1}};return N({handleOpen:A}),(_,l)=>{const B=u("el-checkbox"),R=u("el-empty"),h=u("el-checkbox-group"),w=u("el-form-item"),f=u("el-tag"),E=u("el-input-number"),Z=u("el-switch"),K=u("el-radio"),ee=u("el-radio-group"),O=u("el-input"),j=u("el-option"),W=u("el-select"),te=u("el-form"),G=u("el-button"),le=u("el-dialog");return d(),v(le,{"model-value":a.visible,"onUpdate:modelValue":l[11]||(l[11]=s=>C("update:visible",s)),title:"创建镜像预热任务",width:"800px",onOpen:A},{footer:e(()=>[t(G,{onClick:c},{default:e(()=>[...l[14]||(l[14]=[n("取消",-1)])]),_:1}),t(G,{type:"primary",onClick:o,loading:r.value},{default:e(()=>[...l[15]||(l[15]=[n(" 创建任务 ",-1)])]),_:1},8,["loading"])]),default:e(()=>[t(te,{"label-width":"120px"},{default:e(()=>[t(w,{label:"镜像列表"},{default:e(()=>[t(h,{modelValue:z.value,"onUpdate:modelValue":l[0]||(l[0]=s=>z.value=s)},{default:e(()=>[y("div",be,[(d(!0),D(L,null,F(p.value,s=>(d(),v(B,{key:s.id,label:s.id,border:""},{default:e(()=>[y("div",ke,[y("div",_e,i(s.name),1),y("div",xe,i(s.image),1)])]),_:2},1032,["label"]))),128))]),g.value?(d(),D("div",we,"加载中...")):p.value.length===0?(d(),v(R,{key:1,description:"暂无镜像","image-size":80})):k("",!0)]),_:1},8,["modelValue"])]),_:1}),t(w,{label:"已选镜像"},{default:e(()=>[y("div",Ve,[(d(!0),D(L,null,F(z.value,s=>(d(),v(f,{key:s,closable:"",onClose:()=>{const q=z.value.indexOf(s);q>-1&&z.value.splice(q,1)}},{default:e(()=>[n(i(p.value.find(q=>q.id===s)?.name),1)]),_:2},1032,["onClose"]))),128))])]),_:1}),t(w,{label:"批次大小"},{default:e(()=>[t(E,{modelValue:m.value.batchSize,"onUpdate:modelValue":l[1]||(l[1]=s=>m.value.batchSize=s),min:1,max:100},null,8,["modelValue"])]),_:1}),t(w,{label:"优先级"},{default:e(()=>[t(E,{modelValue:m.value.priority,"onUpdate:modelValue":l[2]||(l[2]=s=>m.value.priority=s),min:1,max:10},null,8,["modelValue"])]),_:1}),t(w,{label:"私有仓库"},{default:e(()=>[t(Z,{modelValue:M.value,"onUpdate:modelValue":l[3]||(l[3]=s=>M.value=s)},null,8,["modelValue"])]),_:1}),M.value?(d(),D(L,{key:0},[t(w,{label:"认证方式"},{default:e(()=>[t(ee,{modelValue:V.value,"onUpdate:modelValue":l[4]||(l[4]=s=>V.value=s)},{default:e(()=>[t(K,{value:"manual"},{default:e(()=>[...l[12]||(l[12]=[n("手动输入",-1)])]),_:1}),t(K,{value:"select"},{default:e(()=>[...l[13]||(l[13]=[n("选择已保存",-1)])]),_:1})]),_:1},8,["modelValue"])]),_:1}),V.value==="manual"?(d(),D(L,{key:0},[t(w,{label:"仓库地址",required:""},{default:e(()=>[t(O,{modelValue:m.value.registry,"onUpdate:modelValue":l[5]||(l[5]=s=>m.value.registry=s),placeholder:"harbor.example.com"},null,8,["modelValue"])]),_:1}),t(w,{label:"用户名",required:""},{default:e(()=>[t(O,{modelValue:m.value.username,"onUpdate:modelValue":l[6]||(l[6]=s=>m.value.username=s)},null,8,["modelValue"])]),_:1}),t(w,{label:"密码",required:""},{default:e(()=>[t(O,{modelValue:m.value.password,"onUpdate:modelValue":l[7]||(l[7]=s=>m.value.password=s),type:"password","show-password":""},null,8,["modelValue"])]),_:1})],64)):k("",!0),V.value==="select"?(d(),v(w,{key:1,label:"选择认证",required:""},{default:e(()=>[t(W,{modelValue:m.value.secretId,"onUpdate:modelValue":l[8]||(l[8]=s=>m.value.secretId=s),placeholder:"请选择认证",style:{width:"100%"}},{default:e(()=>[(d(!0),D(L,null,F(b.value,s=>(d(),v(j,{key:s.id,label:s.name,value:s.id},{default:e(()=>[y("span",he,i(s.name),1),y("span",Se,i(s.registry),1)]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})):k("",!0)],64)):k("",!0),t(w,{label:"最大重试"},{default:e(()=>[t(E,{modelValue:m.value.maxRetries,"onUpdate:modelValue":l[9]||(l[9]=s=>m.value.maxRetries=s),min:0,max:5},null,8,["modelValue"])]),_:1}),t(w,{label:"重试策略"},{default:e(()=>[t(W,{modelValue:m.value.retryStrategy,"onUpdate:modelValue":l[10]||(l[10]=s=>m.value.retryStrategy=s)},{default:e(()=>[t(j,{label:"线性",value:"linear"}),t(j,{label:"指数退避",value:"exponential"})]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1},8,["model-value"])}}}),ze=J(Ce,[["__scopeId","data-v-d58957dc"]]),De={class:"tasks"},$e={class:"header"},Ue={class:"header-right"},Me={key:0},Te={style:{display:"flex","justify-content":"center","margin-top":"20px"}},Be=H({__name:"TasksView",setup(a){const N=x([]),$=x(!1),C=x(!1),m=x(!1),M=x(null),V=x([]),z=x(null),p=x({page:1,pageSize:10,total:0}),b=async()=>{try{$.value=!0;const c=(p.value.page-1)*p.value.pageSize,o=await P.list({limit:p.value.pageSize,offset:c});N.value=o.tasks,p.value.total=o.total||o.tasks.length}catch{S.error("加载任务失败")}finally{$.value=!1}},r=()=>{b()};se(C,c=>{c&&z.value&&z.value.handleOpen()});const g=c=>{M.value=c,m.value=!0},T=c=>{p.value.page=c,b()},I=c=>{p.value.pageSize=c,p.value.page=1,b()},U=async c=>{try{await Q.confirm("确定要删除这个任务吗？","确认删除",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await P.delete(c.taskId),S.success("任务已删除"),b()}catch(o){o!=="cancel"&&(console.error("Delete task error:",o),S.error(`删除失败: ${o instanceof Error?o.message:"未知错误"}`))}},A=async()=>{if(V.value.length===0){S.warning("请选择要删除的任务");return}try{await Q.confirm(`确定要删除选中的 ${V.value.length} 个任务吗？`,"确认批量删除",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});const c=V.value.map(o=>P.delete(o.taskId));await Promise.all(c),S.success(`成功删除了 ${c.length} 个任务`),V.value=[],b()}catch(c){c!=="cancel"&&(console.error("Bulk delete error:",c),S.error(`批量删除失败: ${c instanceof Error?c.message:"未知错误"}`))}};return ne(()=>{b()}),ie(()=>{}),(c,o)=>{const _=u("el-button"),l=u("el-table-column"),B=u("el-tag"),R=u("el-table"),h=u("el-pagination"),w=Y("loading");return d(),D("div",De,[y("div",$e,[o[7]||(o[7]=y("h2",null,"任务管理",-1)),y("div",Ue,[V.value.length>0?(d(),v(_,{key:0,type:"danger",onClick:A,disabled:V.value.length===0},{default:e(()=>[n(" 批量删除 ("+i(V.value.length)+") ",1)]),_:1},8,["disabled"])):k("",!0),t(_,{type:"primary",onClick:o[0]||(o[0]=f=>C.value=!0)},{default:e(()=>[...o[6]||(o[6]=[n("新建任务",-1)])]),_:1})])]),X((d(),v(R,{data:N.value,style:{width:"100%"},onSelectionChange:o[1]||(o[1]=f=>V.value=f)},{default:e(()=>[t(l,{type:"selection",width:"55"}),t(l,{prop:"taskId",label:"任务ID",width:"180"}),t(l,{prop:"status",label:"状态",width:"100"},{default:e(({row:f})=>[t(B,{type:f.status==="completed"?"success":f.status==="failed"?"danger":"info"},{default:e(()=>[n(i(f.status),1)]),_:2},1032,["type"])]),_:1}),t(l,{prop:"images",label:"镜像"},{default:e(({row:f})=>[n(i(f.images[0])+" ",1),f.images.length>1?(d(),D("span",Me,"+"+i(f.images.length-1),1)):k("",!0)]),_:1}),t(l,{prop:"progress.percentage",label:"进度",width:"120"},{default:e(({row:f})=>[n(i(f.progress?.percentage?.toFixed(1)||0)+"% ",1)]),_:1}),t(l,{prop:"createdAt",label:"创建时间",width:"180"},{default:e(({row:f})=>[n(i(new Date(f.createdAt).toLocaleString()),1)]),_:1}),t(l,{label:"操作",width:"200"},{default:e(({row:f})=>[t(_,{size:"small",onClick:E=>g(f)},{default:e(()=>[...o[8]||(o[8]=[n("详情",-1)])]),_:1},8,["onClick"]),t(_,{size:"small",type:"danger",onClick:E=>U(f)},{default:e(()=>[...o[9]||(o[9]=[n("删除",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[w,$.value]]),y("div",Te,[t(h,{"current-page":p.value.page,"onUpdate:currentPage":o[2]||(o[2]=f=>p.value.page=f),"page-size":p.value.pageSize,"onUpdate:pageSize":o[3]||(o[3]=f=>p.value.pageSize=f),"page-sizes":[10,20,50],total:p.value.total,layout:"sizes, prev, pager, next, total",background:!0,onSizeChange:I,onCurrentChange:T},null,8,["current-page","page-size","total"])]),t(ze,{visible:C.value,"onUpdate:visible":o[4]||(o[4]=f=>C.value=f),onSuccess:r},null,8,["visible"]),t(ye,{visible:m.value,task:M.value,"onUpdate:visible":o[5]||(o[5]=f=>m.value=f)},null,8,["visible","task"])])}}}),Le=J(Be,[["__scopeId","data-v-2c89d535"]]);export{Le as default};
