import{a as H}from"./index-DjcwJUKl.js";import{s as P,t as U}from"./api-6KZm3PBg.js";import{d as q,Q as G,l as _,q as i,t as o,v as r,B as O,c as Q,H as R,r as g,A as w,a as c,S as J,o as d,F as K,D as W,G as u,z as S}from"./element-plus-K37pJI3g.js";import{_ as X}from"./_plugin-vue_export-helper-DlAUqK2U.js";const Y={class:"max-w-[1200px] mx-auto py-6 px-4 sm:px-6 lg:px-8"},Z={class:"mb-4 flex gap-4 items-center"},ee={class:"flex items-center gap-2"},te={class:"bg-white dark:bg-slate-800 rounded-xl p-6 shadow-sm border border-slate-200 dark:border-slate-700"},ae=["onClick"],se={class:"font-mono text-slate-600 dark:text-slate-400"},oe={class:"text-slate-600 dark:text-slate-400 text-sm"},le={class:"text-slate-600 dark:text-slate-400 text-sm"},ne={key:0,class:"text-xs text-red-500 dark:text-red-400 font-mono"},ie={key:1,class:"text-slate-400"},re={class:"mt-6 flex justify-center"},ce={key:0,class:"mt-8 flex justify-center"},de=q({__name:"ScheduledHistoryView",setup(ue){const z=H(),m=g(!1),f=g([]),x=g(new Map),l=g({page:1,pageSize:20,total:0}),h=g("all"),b=[{label:"全部",value:"all"},{label:"成功",value:"success"},{label:"失败",value:"failed"},{label:"跳过",value:"skipped"},{label:"超时",value:"timeout"}],v=async()=>{const t=z.query.scheduledTaskId;if(!t){w.warning("缺少定时任务ID");return}try{m.value=!0;const a=(l.value.page-1)*l.value.pageSize,n=await P.listExecutions({scheduledTaskId:t,limit:l.value.pageSize,offset:a});f.value=n.executions,l.value.total=n.total;const k=[...new Set(n.executions.map(s=>s.taskId))];for(const s of k)if(!x.value.has(s))try{const p=await U.get(s);x.value.set(s,p)}catch(p){console.error(`Failed to load task ${s}:`,p)}}catch(a){w.error("加载执行历史失败"),console.error(a)}finally{m.value=!1}},C=t=>{l.value.page=t,v()},I=t=>{l.value.pageSize=t,l.value.page=1,v()},D=t=>{h.value=t,l.value.page=1,v()},V=t=>{switch(t){case"success":return"success";case"failed":return"danger";case"skipped":return"info";case"timeout":return"warning";default:return"info"}},A=t=>b.find(n=>n.value===t)?.label||t,T=t=>{if(!t||t===0)return"0s";const a=Math.floor(t/60),n=t%60;return a>0?`${a}m ${n}s`:`${n}s`},$=t=>x.value.get(t)?.taskId||t,y=t=>{const a=f.value.find(n=>n.id===t);a&&window.open(`/web/tasks/${a.taskId}`,"_blank")};return G(()=>{v()}),(t,a)=>{const n=c("el-option"),k=c("el-select"),s=c("el-table-column"),p=c("el-tag"),M=c("el-tooltip"),B=c("el-button"),F=c("el-table"),N=c("el-pagination"),E=c("el-empty"),L=J("loading");return d(),_("div",Y,[a[5]||(a[5]=i("div",{class:"flex justify-between items-center mb-6"},[i("h2",{class:"text-2xl font-bold text-slate-900 dark:text-white"},"定时任务执行历史"),i("div",{class:"flex gap-3"})],-1)),i("div",Z,[i("div",ee,[a[3]||(a[3]=i("span",{class:"text-sm font-medium text-slate-600 dark:text-slate-400"},"状态:",-1)),o(k,{modelValue:h.value,"onUpdate:modelValue":a[0]||(a[0]=e=>h.value=e),class:"w-[200px]",onChange:D},{default:r(()=>[(d(),_(K,null,W(b,e=>o(n,{key:e.value,label:e.label,value:e.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"])])]),i("div",te,[O((d(),Q(F,{data:f.value,style:{width:"100%"},"header-cell-style":{background:"transparent",color:"inherit"}},{default:r(()=>[o(s,{prop:"id",label:"执行ID",width:"100"}),o(s,{prop:"taskId",label:"任务ID",width:"180"},{default:r(({row:e})=>[i("span",{class:"text-cyan-600 dark:text-cyan-400 hover:text-cyan-700 dark:hover:text-cyan-300 font-mono cursor-pointer underline decoration-cyan-500/30 hover:decoration-cyan-500 transition-all",onClick:j=>y(e.id)},u($(e.taskId)),9,ae)]),_:1}),o(s,{prop:"status",label:"状态",width:"100"},{default:r(({row:e})=>[o(p,{type:V(e.status),effect:"light",class:"!border-0"},{default:r(()=>[S(u(A(e.status)),1)]),_:2},1032,["type"])]),_:1}),o(s,{prop:"durationSeconds",label:"耗时",width:"120"},{default:r(({row:e})=>[o(M,{content:`${e.durationSeconds}秒`},{default:r(()=>[i("span",se,u(T(e.durationSeconds)),1)]),_:2},1032,["content"])]),_:1}),o(s,{prop:"startedAt",label:"开始时间",width:"180"},{default:r(({row:e})=>[i("span",oe,u(new Date(e.startedAt).toLocaleString()),1)]),_:1}),o(s,{prop:"finishedAt",label:"结束时间",width:"180"},{default:r(({row:e})=>[i("span",le,u(e.finishedAt?new Date(e.finishedAt).toLocaleString():"-"),1)]),_:1}),o(s,{prop:"errorMessage",label:"错误信息","min-width":"200"},{default:r(({row:e})=>[e.errorMessage?(d(),_("span",ne,u(e.errorMessage),1)):(d(),_("span",ie,"-"))]),_:1}),o(s,{label:"操作",width:"100",fixed:"right"},{default:r(({row:e})=>[o(B,{type:"primary",link:"",size:"small",onClick:j=>y(e.id)},{default:r(()=>[...a[4]||(a[4]=[S(" 查看任务 ",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[L,m.value]]),i("div",re,[o(N,{"current-page":l.value.page,"onUpdate:currentPage":a[1]||(a[1]=e=>l.value.page=e),"page-size":l.value.pageSize,"onUpdate:pageSize":a[2]||(a[2]=e=>l.value.pageSize=e),"page-sizes":[10,20,50,100],total:l.value.total,layout:"sizes, prev, pager, next, total",background:!0,onSizeChange:I,onCurrentChange:C},null,8,["current-page","page-size","total"])])]),!m.value&&f.value.length===0?(d(),_("div",ce,[o(E,{description:"暂无执行历史记录","image-size":120})])):R("",!0)])}}}),fe=X(de,[["__scopeId","data-v-a2969e41"]]);export{fe as default};
