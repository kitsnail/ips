import{t as H,l as ie,b as re}from"./index-BE6ap8Ug.js";import{d as G,c as k,w as e,i as f,o as u,I as Z,a as T,f as t,b as r,D as i,j as o,C as x,F as O,B as W,r as b,E as D,J as ee,h as ue,t as de,A as me,H as ce,K as Y}from"./element-plus-DT46MLQ6.js";import{_ as Q}from"./_plugin-vue_export-helper-DlAUqK2U.js";const pe={key:0},fe={style:{"font-family":"monospace",color:"#0891b2"}},ge={style:{"font-family":"monospace"}},ve={style:{display:"grid","grid-template-columns":"repeat(2, 1fr)",gap:"8px"}},ye={style:{"margin-top":"8px"}},ke={style:{display:"flex","align-items":"center",gap:"8px"}},be={style:{"font-family":"monospace",color:"#0891b2","font-weight":"500"}},we={style:{"font-family":"monospace"}},_e=G({__name:"TaskDetailModal",props:{visible:{type:Boolean},task:{}},emits:["update:visible","cancel"],setup(a,{emit:E}){const A=E,$=a,c=b(!1),L=async()=>{if($.task)try{c.value=!0,await H.delete($.task.taskId),D.success("任务已取消"),A("cancel")}catch{D.error("取消任务失败")}finally{c.value=!1}},V=_=>({pending:"等待中",running:"运行中",completed:"已完成",failed:"失败",cancelled:"已取消"})[_]||_,h=_=>({pending:"info",running:"warning",completed:"success",failed:"danger",cancelled:"info"})[_]||"info",w=_=>_?new Date(_).toLocaleString():"-";return(_,d)=>{const v=f("el-descriptions-item"),R=f("el-tag"),M=f("el-descriptions"),I=f("el-divider"),B=f("el-scrollbar"),g=f("el-alert"),n=f("el-table-column"),N=f("el-table"),S=f("el-button"),F=f("el-dialog"),q=ee("loading");return u(),k(F,{"model-value":a.visible,"onUpdate:modelValue":d[1]||(d[1]=C=>A("update:visible",C)),title:"任务详情",width:"900px"},{footer:e(()=>[t(S,{onClick:d[0]||(d[0]=C=>A("update:visible",!1))},{default:e(()=>[...d[10]||(d[10]=[o("关闭",-1)])]),_:1}),a.task&&(a.task.status==="pending"||a.task.status==="running")?(u(),k(S,{key:0,type:"danger",loading:c.value,onClick:L},{default:e(()=>[...d[11]||(d[11]=[o(" 取消任务 ",-1)])]),_:1},8,["loading"])):x("",!0)]),default:e(()=>[a.task?Z((u(),T("div",pe,[t(M,{column:2,border:""},{default:e(()=>[t(v,{label:"任务ID"},{default:e(()=>[r("span",fe,i(a.task.taskId),1)]),_:1}),t(v,{label:"状态"},{default:e(()=>[t(R,{type:h(a.task.status)},{default:e(()=>[o(i(V(a.task.status)),1)]),_:1},8,["type"])]),_:1}),t(v,{label:"优先级"},{default:e(()=>[o(i(a.task.priority),1)]),_:1}),t(v,{label:"批次大小"},{default:e(()=>[o(i(a.task.batchSize),1)]),_:1}),t(v,{label:"创建时间"},{default:e(()=>[o(i(w(a.task.createdAt)),1)]),_:1}),a.task.startedAt?(u(),k(v,{key:0,label:"开始时间"},{default:e(()=>[o(i(w(a.task.startedAt)),1)]),_:1})):x("",!0),a.task.finishedAt?(u(),k(v,{key:1,label:"完成时间"},{default:e(()=>[o(i(w(a.task.finishedAt)),1)]),_:1})):x("",!0),t(v,{label:"重试次数"},{default:e(()=>[o(i(a.task.retryCount)+" / "+i(a.task.maxRetries),1)]),_:1}),t(v,{label:"重试策略"},{default:e(()=>[o(i(a.task.retryStrategy==="linear"?"线性":"指数退避"),1)]),_:1}),a.task.retryDelay?(u(),k(v,{key:2,label:"重试延迟"},{default:e(()=>[o(i(a.task.retryDelay)+" 秒 ",1)]),_:1})):x("",!0),a.task.webhookUrl?(u(),k(v,{key:3,label:"Webhook URL"},{default:e(()=>[r("span",ge,i(a.task.webhookUrl),1)]),_:1})):x("",!0)]),_:1}),t(I,{"content-position":"left"},{default:e(()=>[...d[2]||(d[2]=[o("进度",-1)])]),_:1}),a.task.progress?(u(),k(M,{key:0,column:3,border:""},{default:e(()=>[t(v,{label:"总节点数"},{default:e(()=>[o(i(a.task.progress.totalNodes),1)]),_:1}),t(v,{label:"已完成"},{default:e(()=>[o(i(a.task.progress.completedNodes),1)]),_:1}),t(v,{label:"失败"},{default:e(()=>[o(i(a.task.progress.failedNodes),1)]),_:1}),t(v,{label:"当前批次"},{default:e(()=>[o(i(a.task.progress.currentBatch)+" / "+i(a.task.progress.totalBatches),1)]),_:1}),t(v,{label:"完成率"},{default:e(()=>[o(i(a.task.progress.percentage.toFixed(1))+"% ",1)]),_:1})]),_:1})):x("",!0),t(I,{"content-position":"left"},{default:e(()=>[...d[3]||(d[3]=[o("镜像列表",-1)])]),_:1}),t(B,{"max-height":"200px"},{default:e(()=>[r("div",ve,[(u(!0),T(O,null,W(a.task.images,(C,P)=>(u(),k(R,{key:P,style:{"font-family":"monospace","font-size":"13px"}},{default:e(()=>[o(i(C),1)]),_:2},1024))),128))])]),_:1}),a.task.secretName?(u(),k(I,{key:1,"content-position":"left"},{default:e(()=>[...d[4]||(d[4]=[o("私有仓库认证",-1)])]),_:1})):x("",!0),a.task.secretName?(u(),k(g,{key:2,type:"info",closable:!1,style:{"margin-bottom":"24px"}},{title:e(()=>[...d[5]||(d[5]=[r("span",{style:{"font-weight":"600"}},"已启用私有仓库认证",-1)])]),default:e(()=>[r("div",ye,[r("div",ke,[d[6]||(d[6]=r("span",null,"Secret 名称：",-1)),r("span",be,i(a.task.secretName),1)]),d[7]||(d[7]=r("div",{style:{"font-size":"12px",color:"#64748b","margin-top":"4px"}}," 临时 Secret 会在任务完成后自动清理 ",-1))])]),_:1})):x("",!0),a.task.errorMessage?(u(),k(I,{key:3,"content-position":"left"},{default:e(()=>[...d[8]||(d[8]=[o("错误信息",-1)])]),_:1})):x("",!0),a.task.errorMessage?(u(),k(g,{key:4,type:"error",closable:!1},{default:e(()=>[o(i(a.task.errorMessage),1)]),_:1})):x("",!0),a.task.failedNodeDetails&&a.task.failedNodeDetails.length>0?(u(),k(I,{key:5,"content-position":"left"},{default:e(()=>[...d[9]||(d[9]=[o("失败节点详情",-1)])]),_:1})):x("",!0),a.task.failedNodeDetails&&a.task.failedNodeDetails.length>0?(u(),k(N,{key:6,data:a.task.failedNodeDetails,style:{width:"100%","margin-top":"8px"},"max-height":"200px"},{default:e(()=>[t(n,{prop:"nodeName",label:"节点名称",width:"200"}),t(n,{prop:"image",label:"镜像","min-width":"250"},{default:e(({row:C})=>[r("span",we,i(C.image),1)]),_:1}),t(n,{prop:"reason",label:"原因",width:"120"}),t(n,{prop:"message",label:"消息"},{default:e(({row:C})=>[o(i(C.message||"-"),1)]),_:1}),t(n,{prop:"timestamp",label:"时间",width:"180"},{default:e(({row:C})=>[o(i(new Date(C.timestamp).toLocaleString()),1)]),_:1})]),_:1},8,["data"])):x("",!0)])),[[q,c.value]]):x("",!0)]),_:1},8,["model-value"])}}}),xe=Q(_e,[["__scopeId","data-v-de8617c9"]]),Ve={class:"image-section"},he={class:"image-input-section"},Ce={class:"image-library-section"},Se={class:"section-header"},ze={class:"controls"},De={key:0,class:"loading-text"},$e={key:2,class:"table-container"},Ie={class:"image-table"},Ue={class:"url-cell"},Te={style:{float:"left"}},Me={style:{float:"right",color:"#8492a6","font-size":"12px"}},Ae=G({__name:"CreateTaskModal",props:{visible:{type:Boolean}},emits:["update:visible","success"],setup(a,{expose:E,emit:A}){const $=A,c=b({images:[],batchSize:10,priority:5,maxRetries:0,retryStrategy:"linear",retryDelay:30,nodeSelector:{}}),L=b(!1),V=b("manual"),h=b(""),w=b([]),_=b([]),d=b(!1),v=b(!1),R=b(!1),M=b(""),I=b("name"),B=b("asc"),g=async()=>{try{v.value=!0;const m=await ie.list({limit:100});w.value=m.images}catch{D.error("加载镜像库失败")}finally{v.value=!1}},n=async()=>{try{R.value=!0;const m=await re.list({pageSize:100});_.value=m.secrets}catch{D.error("加载认证信息失败")}finally{R.value=!1}},N=()=>{g(),n(),h.value="",M.value=""},S=()=>{$("update:visible",!1)},F=m=>h.value.split(`
`).map(y=>y.trim()).filter(y=>y.length>0).includes(m),q=ue(()=>{let m=w.value;if(M.value){const l=M.value.toLowerCase();m=m.filter(y=>y.name.toLowerCase().includes(l)||y.image.toLowerCase().includes(l))}return I.value==="name"?m=[...m].sort((l,y)=>{const z=l.name.localeCompare(y.name);return B.value==="asc"?z:-z}):m=[...m].sort((l,y)=>{const z=new Date(l.createdAt).getTime()-new Date(y.createdAt).getTime();return B.value==="asc"?z:-z}),m}),C=m=>{if(!F(m)){const l=h.value.split(`
`).map(y=>y.trim()).filter(y=>y.length>0);l.push(m),h.value=l.join(`
`)}},P=m=>{const y=h.value.split(`
`).filter(z=>z.trim()!==m);h.value=y.join(`
`)},p=async()=>{try{const m=h.value.split(`
`).map(l=>l.trim()).filter(l=>l.length>0);if(m.length===0){D.warning("请至少添加一个镜像");return}c.value.images=m,d.value=!0,await H.create(c.value),D.success("任务创建成功"),$("success"),S()}catch(m){D.error(m.response?.data?.error||"创建任务失败")}finally{d.value=!1}};return E({handleOpen:N}),(m,l)=>{const y=f("el-input"),z=f("el-option"),J=f("el-select"),j=f("el-button"),te=f("el-empty"),U=f("el-form-item"),K=f("el-input-number"),le=f("el-switch"),X=f("el-radio"),ae=f("el-radio-group"),se=f("el-form"),ne=f("el-dialog");return u(),k(ne,{"model-value":a.visible,"onUpdate:modelValue":l[14]||(l[14]=s=>$("update:visible",s)),title:"创建镜像预热任务",width:"1200px",onOpen:N},{footer:e(()=>[t(j,{onClick:S},{default:e(()=>[...l[22]||(l[22]=[o("取消",-1)])]),_:1}),t(j,{type:"primary",onClick:p,loading:d.value},{default:e(()=>[...l[23]||(l[23]=[o(" 创建任务 ",-1)])]),_:1},8,["loading"])]),default:e(()=>[t(se,{"label-width":"120px"},{default:e(()=>[t(U,{label:"镜像列表",required:""},{default:e(()=>[r("div",Ve,[r("div",he,[l[15]||(l[15]=r("div",{class:"section-title"},"手动输入",-1)),t(y,{modelValue:h.value,"onUpdate:modelValue":l[0]||(l[0]=s=>h.value=s),type:"textarea",rows:12,placeholder:`每行输入一个镜像地址，例如：
docker.io/library/nginx:latest
registry.cn-hangzhou.aliyuncs.com/library/redis:7`,class:"manual-input"},null,8,["modelValue"])]),r("div",Ce,[r("div",Se,[l[16]||(l[16]=r("div",{class:"section-title"},"从镜像库选择",-1)),r("div",ze,[t(y,{modelValue:M.value,"onUpdate:modelValue":l[1]||(l[1]=s=>M.value=s),placeholder:"搜索镜像...","prefix-icon":"Search",class:"search-input",clearable:""},null,8,["modelValue"]),t(J,{modelValue:I.value,"onUpdate:modelValue":l[2]||(l[2]=s=>I.value=s),class:"sort-select"},{default:e(()=>[t(z,{label:"按名称",value:"name"}),t(z,{label:"按添加时间",value:"createdAt"})]),_:1},8,["modelValue"]),t(j,{icon:B.value==="asc"?"ArrowUp":"ArrowDown",onClick:l[3]||(l[3]=s=>B.value=B.value==="asc"?"desc":"asc"),size:"small"},null,8,["icon"])])]),v.value?(u(),T("div",De,"加载中...")):q.value.length===0?(u(),k(te,{key:1,description:"暂无镜像","image-size":60})):(u(),T("div",$e,[r("table",Ie,[l[19]||(l[19]=r("thead",null,[r("tr",null,[r("th",{style:{width:"60%"}},"显示名称"),r("th",{style:{width:"30%"}},"镜像地址"),r("th",{style:{width:"10%"}},"操作")])],-1)),r("tbody",null,[(u(!0),T(O,null,W(q.value,s=>(u(),T("tr",{key:s.id,class:"table-row"},[r("td",null,i(s.name),1),r("td",Ue,i(s.image),1),r("td",null,[F(s.image)?(u(),k(j,{key:0,type:"danger",size:"small",onClick:oe=>P(s.image)},{default:e(()=>[...l[17]||(l[17]=[o(" 已添加 ",-1)])]),_:1},8,["onClick"])):(u(),k(j,{key:1,type:"primary",size:"small",onClick:oe=>C(s.image)},{default:e(()=>[...l[18]||(l[18]=[o(" 添加 ",-1)])]),_:1},8,["onClick"]))])]))),128))])])]))])])]),_:1}),t(U,{label:"批次大小"},{default:e(()=>[t(K,{modelValue:c.value.batchSize,"onUpdate:modelValue":l[4]||(l[4]=s=>c.value.batchSize=s),min:1,max:100},null,8,["modelValue"])]),_:1}),t(U,{label:"优先级"},{default:e(()=>[t(K,{modelValue:c.value.priority,"onUpdate:modelValue":l[5]||(l[5]=s=>c.value.priority=s),min:1,max:10},null,8,["modelValue"])]),_:1}),t(U,{label:"最大重试"},{default:e(()=>[t(K,{modelValue:c.value.maxRetries,"onUpdate:modelValue":l[6]||(l[6]=s=>c.value.maxRetries=s),min:0,max:5},null,8,["modelValue"])]),_:1}),t(U,{label:"重试策略"},{default:e(()=>[t(J,{modelValue:c.value.retryStrategy,"onUpdate:modelValue":l[7]||(l[7]=s=>c.value.retryStrategy=s)},{default:e(()=>[t(z,{label:"线性",value:"linear"}),t(z,{label:"指数退避",value:"exponential"})]),_:1},8,["modelValue"])]),_:1}),t(U,{label:"私有仓库"},{default:e(()=>[t(le,{modelValue:L.value,"onUpdate:modelValue":l[8]||(l[8]=s=>L.value=s)},null,8,["modelValue"])]),_:1}),L.value?(u(),T(O,{key:0},[t(U,{label:"认证方式"},{default:e(()=>[t(ae,{modelValue:V.value,"onUpdate:modelValue":l[9]||(l[9]=s=>V.value=s)},{default:e(()=>[t(X,{value:"manual"},{default:e(()=>[...l[20]||(l[20]=[o("手动输入",-1)])]),_:1}),t(X,{value:"select"},{default:e(()=>[...l[21]||(l[21]=[o("选择已保存",-1)])]),_:1})]),_:1},8,["modelValue"])]),_:1}),V.value==="manual"?(u(),T(O,{key:0},[t(U,{label:"仓库地址",required:""},{default:e(()=>[t(y,{modelValue:c.value.registry,"onUpdate:modelValue":l[10]||(l[10]=s=>c.value.registry=s),placeholder:"harbor.example.com"},null,8,["modelValue"])]),_:1}),t(U,{label:"用户名",required:""},{default:e(()=>[t(y,{modelValue:c.value.username,"onUpdate:modelValue":l[11]||(l[11]=s=>c.value.username=s)},null,8,["modelValue"])]),_:1}),t(U,{label:"密码",required:""},{default:e(()=>[t(y,{modelValue:c.value.password,"onUpdate:modelValue":l[12]||(l[12]=s=>c.value.password=s),type:"password","show-password":""},null,8,["modelValue"])]),_:1})],64)):x("",!0),V.value==="select"?(u(),k(U,{key:1,label:"选择认证",required:""},{default:e(()=>[t(J,{modelValue:c.value.secretId,"onUpdate:modelValue":l[13]||(l[13]=s=>c.value.secretId=s),placeholder:"请选择认证",style:{width:"100%"}},{default:e(()=>[(u(!0),T(O,null,W(_.value,s=>(u(),k(z,{key:s.id,label:s.name,value:s.id},{default:e(()=>[r("span",Te,i(s.name),1),r("span",Me,i(s.registry),1)]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})):x("",!0)],64)):x("",!0)]),_:1})]),_:1},8,["model-value"])}}}),Be=Q(Ae,[["__scopeId","data-v-e94ede89"]]),Ne={class:"tasks"},Le={class:"header"},Re={class:"header-right"},Ee={key:0},Fe={style:{display:"flex","justify-content":"center","margin-top":"20px"}},qe=G({__name:"TasksView",setup(a){const E=b([]),A=b(!1),$=b(!1),c=b(!1),L=b(null),V=b([]),h=b(null),w=b({page:1,pageSize:10,total:0}),_=async()=>{try{A.value=!0;const g=(w.value.page-1)*w.value.pageSize,n=await H.list({limit:w.value.pageSize,offset:g});E.value=n.tasks,w.value.total=n.total||n.tasks.length}catch{D.error("加载任务失败")}finally{A.value=!1}},d=()=>{_()};de($,g=>{g&&h.value&&h.value.handleOpen()});const v=g=>{L.value=g,c.value=!0},R=g=>{w.value.page=g,_()},M=g=>{w.value.pageSize=g,w.value.page=1,_()},I=async g=>{try{await Y.confirm("确定要删除这个任务吗？","确认删除",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await H.delete(g.taskId),D.success("任务已删除"),_()}catch(n){n!=="cancel"&&(console.error("Delete task error:",n),D.error(`删除失败: ${n instanceof Error?n.message:"未知错误"}`))}},B=async()=>{if(V.value.length===0){D.warning("请选择要删除的任务");return}try{await Y.confirm(`确定要删除选中的 ${V.value.length} 个任务吗？`,"确认批量删除",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});const g=V.value.map(n=>H.delete(n.taskId));await Promise.all(g),D.success(`成功删除了 ${g.length} 个任务`),V.value=[],_()}catch(g){g!=="cancel"&&(console.error("Bulk delete error:",g),D.error(`批量删除失败: ${g instanceof Error?g.message:"未知错误"}`))}};return me(()=>{_()}),ce(()=>{}),(g,n)=>{const N=f("el-button"),S=f("el-table-column"),F=f("el-tag"),q=f("el-table"),C=f("el-pagination"),P=ee("loading");return u(),T("div",Ne,[r("div",Le,[n[7]||(n[7]=r("h2",null,"任务管理",-1)),r("div",Re,[V.value.length>0?(u(),k(N,{key:0,type:"danger",onClick:B,disabled:V.value.length===0},{default:e(()=>[o(" 批量删除 ("+i(V.value.length)+") ",1)]),_:1},8,["disabled"])):x("",!0),t(N,{type:"primary",onClick:n[0]||(n[0]=p=>$.value=!0)},{default:e(()=>[...n[6]||(n[6]=[o("新建任务",-1)])]),_:1})])]),Z((u(),k(q,{data:E.value,style:{width:"100%"},onSelectionChange:n[1]||(n[1]=p=>V.value=p)},{default:e(()=>[t(S,{type:"selection",width:"55"}),t(S,{prop:"taskId",label:"任务ID",width:"180"}),t(S,{prop:"status",label:"状态",width:"100"},{default:e(({row:p})=>[t(F,{type:p.status==="completed"?"success":p.status==="failed"?"danger":"info"},{default:e(()=>[o(i(p.status),1)]),_:2},1032,["type"])]),_:1}),t(S,{prop:"images",label:"镜像"},{default:e(({row:p})=>[o(i(p.images[0])+" ",1),p.images.length>1?(u(),T("span",Ee,"+"+i(p.images.length-1),1)):x("",!0)]),_:1}),t(S,{prop:"progress.percentage",label:"进度",width:"120"},{default:e(({row:p})=>[o(i(p.progress?.percentage?.toFixed(1)||0)+"% ",1)]),_:1}),t(S,{prop:"createdAt",label:"创建时间",width:"180"},{default:e(({row:p})=>[o(i(new Date(p.createdAt).toLocaleString()),1)]),_:1}),t(S,{label:"操作",width:"200"},{default:e(({row:p})=>[t(N,{size:"small",onClick:m=>v(p)},{default:e(()=>[...n[8]||(n[8]=[o("详情",-1)])]),_:1},8,["onClick"]),t(N,{size:"small",type:"danger",onClick:m=>I(p)},{default:e(()=>[...n[9]||(n[9]=[o("删除",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[P,A.value]]),r("div",Fe,[t(C,{"current-page":w.value.page,"onUpdate:currentPage":n[2]||(n[2]=p=>w.value.page=p),"page-size":w.value.pageSize,"onUpdate:pageSize":n[3]||(n[3]=p=>w.value.pageSize=p),"page-sizes":[10,20,50],total:w.value.total,layout:"sizes, prev, pager, next, total",background:!0,onSizeChange:M,onCurrentChange:R},null,8,["current-page","page-size","total"])]),t(Be,{visible:$.value,"onUpdate:visible":n[4]||(n[4]=p=>$.value=p),onSuccess:d},null,8,["visible"]),t(xe,{visible:c.value,task:L.value,"onUpdate:visible":n[5]||(n[5]=p=>c.value=p)},null,8,["visible","task"])])}}}),He=Q(qe,[["__scopeId","data-v-2c89d535"]]);export{He as default};
