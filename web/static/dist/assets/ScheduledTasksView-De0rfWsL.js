import{s as v}from"./index-Cnh6YuTo.js";import{d as O,A as Q,H as W,I as X,a as B,b as w,c as Y,w as t,C as A,f as l,r as f,E as r,i,J as Z,o as z,j as s,D as y,K as I}from"./element-plus-DT46MLQ6.js";import{_ as ee}from"./_plugin-vue_export-helper-DlAUqK2U.js";const le={class:"scheduled-tasks"},ae={class:"header"},te={class:"header-right"},oe={key:0},ne=O({__name:"ScheduledTasksView",setup(ue){const U=f(!1),T=f([]),V=f(!1),C=f(!1),p=f([]),k=f(null);let E=null;const m=f(""),n=f({name:"",description:"",cronExpr:"",enabled:!0,taskConfig:{images:[],batchSize:10,priority:5,maxRetries:0,retryStrategy:"linear",retryDelay:30,webhookUrl:""},overlapPolicy:"skip",timeoutSeconds:0}),c=async()=>{try{U.value=!0;const o=await v.list({limit:50,offset:0});T.value=o.tasks}catch{r.error("加载定时任务失败")}finally{U.value=!1}},M=async()=>{try{const o=m.value.split(`
`).map(u=>u.trim()).filter(u=>u.length>0);if(o.length===0){r.warning("请至少输入一个镜像地址");return}const e={...n.value,taskConfig:{...n.value.taskConfig,images:o}};await v.create(e),r.success("定时任务创建成功"),V.value=!1,m.value="",_(),c()}catch{r.error("创建定时任务失败")}},N=async o=>{try{o.enabled?(await v.disable(o.id),r.success("定时任务已禁用")):(await v.enable(o.id),r.success("定时任务已启用")),c()}catch{r.error("操作失败")}},j=async o=>{try{await v.trigger(o.id),r.success("定时任务已触发")}catch{r.error("触发失败")}},R=async o=>{try{await I.confirm("确定要删除这个定时任务吗？","确认删除",{type:"warning"}),await v.delete(o.id),r.success("定时任务已删除"),c()}catch(e){e!=="cancel"&&r.error("删除失败")}},F=async o=>{k.value={...o},n.value={name:o.name,description:o.description||"",cronExpr:o.cronExpr,enabled:o.enabled,taskConfig:{...o.taskConfig},overlapPolicy:o.overlapPolicy,timeoutSeconds:o.timeoutSeconds},m.value=o.taskConfig.images.join(`
`),C.value=!0},H=async()=>{try{if(!k.value)return;const o=m.value.split(`
`).map(u=>u.trim()).filter(u=>u.length>0);if(o.length===0){r.warning("请至少输入一个镜像地址");return}const e={...n.value,taskConfig:{...n.value.taskConfig,images:o}};await v.update(k.value.id,e),r.success("定时任务更新成功"),C.value=!1,k.value=null,_(),c()}catch{r.error("更新定时任务失败")}},J=async()=>{if(p.value.length===0){r.warning("请选择要删除的定时任务");return}try{await I.confirm(`确定要删除选中的 ${p.value.length} 个定时任务吗？`,"确认批量删除",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});const o=p.value.map(e=>v.delete(e.id));await Promise.all(o),r.success(`成功删除了 ${o.length} 个定时任务`),p.value=[],c()}catch(o){o!=="cancel"&&r.error("批量删除失败")}},_=()=>{n.value={name:"",description:"",cronExpr:"",enabled:!0,taskConfig:{images:[],batchSize:10,priority:5,maxRetries:0,retryStrategy:"linear",retryDelay:30,webhookUrl:""},overlapPolicy:"skip",timeoutSeconds:0},m.value="",k.value=null};return Q(()=>{c(),E=window.setInterval(()=>{c()},5e3)}),W(()=>{E&&clearInterval(E)}),(o,e)=>{const u=i("el-button"),g=i("el-table-column"),K=i("el-tag"),L=i("el-table"),b=i("el-input"),d=i("el-form-item"),x=i("el-input-number"),D=i("el-switch"),S=i("el-option"),P=i("el-select"),$=i("el-form"),q=i("el-dialog"),G=Z("loading");return X((z(),B("div",le,[w("div",ae,[e[21]||(e[21]=w("h2",null,"定时任务管理",-1)),w("div",te,[p.value.length>0?(z(),Y(u,{key:0,type:"danger",onClick:J,disabled:p.value.length===0},{default:t(()=>[s(" 批量删除 ("+y(p.value.length)+") ",1)]),_:1},8,["disabled"])):A("",!0),l(u,{type:"primary",onClick:e[0]||(e[0]=a=>V.value=!0)},{default:t(()=>[...e[20]||(e[20]=[s("新建定时任务",-1)])]),_:1})])]),l(L,{data:T.value,style:{width:"100%"},onSelectionChange:e[1]||(e[1]=a=>p.value=a)},{default:t(()=>[l(g,{type:"selection",width:"55"}),l(g,{prop:"name",label:"任务名称",width:"200"}),l(g,{prop:"cronExpr",label:"Cron表达式",width:"150"}),l(g,{prop:"taskConfig.images",label:"镜像","min-width":"200"},{default:t(({row:a})=>[s(y(a.taskConfig.images[0])+" ",1),a.taskConfig.images.length>1?(z(),B("span",oe,"+"+y(a.taskConfig.images.length-1),1)):A("",!0)]),_:1}),l(g,{prop:"enabled",label:"状态",width:"100"},{default:t(({row:a})=>[l(K,{type:a.enabled?"success":"info"},{default:t(()=>[s(y(a.enabled?"已启用":"已禁用"),1)]),_:2},1032,["type"])]),_:1}),l(g,{prop:"createdAt",label:"创建时间",width:"180"},{default:t(({row:a})=>[s(y(new Date(a.createdAt).toLocaleString()),1)]),_:1}),l(g,{label:"操作",width:"320",fixed:"right"},{default:t(({row:a})=>[l(u,{size:"small",onClick:h=>F(a)},{default:t(()=>[...e[22]||(e[22]=[s(" 编辑 ",-1)])]),_:1},8,["onClick"]),l(u,{size:"small",onClick:h=>N(a)},{default:t(()=>[s(y(a.enabled?"禁用":"启用"),1)]),_:2},1032,["onClick"]),l(u,{size:"small",type:"primary",onClick:h=>j(a)},{default:t(()=>[...e[23]||(e[23]=[s(" 触发 ",-1)])]),_:1},8,["onClick"]),l(u,{size:"small",type:"danger",onClick:h=>R(a)},{default:t(()=>[...e[24]||(e[24]=[s(" 删除 ",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"]),l(q,{"model-value":V.value,"onUpdate:modelValue":e[10]||(e[10]=a=>V.value=a),title:"创建定时任务",width:"700px",onClose:_},{footer:t(()=>[l(u,{onClick:e[9]||(e[9]=a=>V.value=!1)},{default:t(()=>[...e[26]||(e[26]=[s("取消",-1)])]),_:1}),l(u,{type:"primary",onClick:M},{default:t(()=>[...e[27]||(e[27]=[s("创建",-1)])]),_:1})]),default:t(()=>[l($,{"label-width":"120px"},{default:t(()=>[l(d,{label:"任务名称",required:""},{default:t(()=>[l(b,{modelValue:n.value.name,"onUpdate:modelValue":e[2]||(e[2]=a=>n.value.name=a),placeholder:"例如：每日镜像预热"},null,8,["modelValue"])]),_:1}),l(d,{label:"Cron表达式",required:""},{default:t(()=>[l(b,{modelValue:n.value.cronExpr,"onUpdate:modelValue":e[3]||(e[3]=a=>n.value.cronExpr=a),placeholder:"0 2 * * *"},null,8,["modelValue"]),e[25]||(e[25]=w("div",{style:{"font-size":"12px",color:"#64748b","margin-top":"4px"}}," 示例：每天凌晨2点（0 2 * * *）、每小时（0 * * * *） ",-1))]),_:1}),l(d,{label:"镜像列表",required:""},{default:t(()=>[l(b,{modelValue:m.value,"onUpdate:modelValue":e[4]||(e[4]=a=>m.value=a),type:"textarea",rows:4,placeholder:"每行一个镜像地址"},null,8,["modelValue"])]),_:1}),l(d,{label:"批次大小"},{default:t(()=>[l(x,{modelValue:n.value.taskConfig.batchSize,"onUpdate:modelValue":e[5]||(e[5]=a=>n.value.taskConfig.batchSize=a),min:1,max:100},null,8,["modelValue"])]),_:1}),l(d,{label:"启用任务"},{default:t(()=>[l(D,{modelValue:n.value.enabled,"onUpdate:modelValue":e[6]||(e[6]=a=>n.value.enabled=a)},null,8,["modelValue"])]),_:1}),l(d,{label:"重叠策略"},{default:t(()=>[l(P,{modelValue:n.value.overlapPolicy,"onUpdate:modelValue":e[7]||(e[7]=a=>n.value.overlapPolicy=a)},{default:t(()=>[l(S,{label:"跳过（不执行）",value:"skip"}),l(S,{label:"允许（排队）",value:"allow"})]),_:1},8,["modelValue"])]),_:1}),l(d,{label:"超时时间（秒）"},{default:t(()=>[l(x,{modelValue:n.value.timeoutSeconds,"onUpdate:modelValue":e[8]||(e[8]=a=>n.value.timeoutSeconds=a),min:0},null,8,["modelValue"])]),_:1})]),_:1})]),_:1},8,["model-value"]),l(q,{"model-value":C.value,"onUpdate:modelValue":e[19]||(e[19]=a=>C.value=a),title:"编辑定时任务",width:"700px",onClose:_},{footer:t(()=>[l(u,{onClick:e[18]||(e[18]=a=>C.value=!1)},{default:t(()=>[...e[29]||(e[29]=[s("取消",-1)])]),_:1}),l(u,{type:"primary",onClick:H},{default:t(()=>[...e[30]||(e[30]=[s("更新",-1)])]),_:1})]),default:t(()=>[l($,{"label-width":"120px"},{default:t(()=>[l(d,{label:"任务名称",required:""},{default:t(()=>[l(b,{modelValue:n.value.name,"onUpdate:modelValue":e[11]||(e[11]=a=>n.value.name=a),placeholder:"例如：每日镜像预热"},null,8,["modelValue"])]),_:1}),l(d,{label:"Cron表达式",required:""},{default:t(()=>[l(b,{modelValue:n.value.cronExpr,"onUpdate:modelValue":e[12]||(e[12]=a=>n.value.cronExpr=a),placeholder:"0 2 * * *"},null,8,["modelValue"]),e[28]||(e[28]=w("div",{style:{"font-size":"12px",color:"#64748b","margin-top":"4px"}}," 示例：每天凌晨2点（0 2 * * *）、每小时（0 * * * *） ",-1))]),_:1}),l(d,{label:"镜像列表",required:""},{default:t(()=>[l(b,{modelValue:m.value,"onUpdate:modelValue":e[13]||(e[13]=a=>m.value=a),type:"textarea",rows:4,placeholder:"每行一个镜像地址"},null,8,["modelValue"])]),_:1}),l(d,{label:"批次大小"},{default:t(()=>[l(x,{modelValue:n.value.taskConfig.batchSize,"onUpdate:modelValue":e[14]||(e[14]=a=>n.value.taskConfig.batchSize=a),min:1,max:100},null,8,["modelValue"])]),_:1}),l(d,{label:"启用任务"},{default:t(()=>[l(D,{modelValue:n.value.enabled,"onUpdate:modelValue":e[15]||(e[15]=a=>n.value.enabled=a)},null,8,["modelValue"])]),_:1}),l(d,{label:"重叠策略"},{default:t(()=>[l(P,{modelValue:n.value.overlapPolicy,"onUpdate:modelValue":e[16]||(e[16]=a=>n.value.overlapPolicy=a)},{default:t(()=>[l(S,{label:"跳过（不执行）",value:"skip"}),l(S,{label:"允许（排队）",value:"allow"})]),_:1},8,["modelValue"])]),_:1}),l(d,{label:"超时时间（秒）"},{default:t(()=>[l(x,{modelValue:n.value.timeoutSeconds,"onUpdate:modelValue":e[17]||(e[17]=a=>n.value.timeoutSeconds=a),min:0},null,8,["modelValue"])]),_:1})]),_:1})]),_:1},8,["model-value"])])),[[G,U.value]])}}}),ie=ee(ne,[["__scopeId","data-v-c6b7d895"]]);export{ie as default};
