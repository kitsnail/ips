import{t as R,l as ae,b as se}from"./index-Cnh6YuTo.js";import{d as j,c as v,w as e,i as r,o as d,I as Q,a as I,f as t,b as g,D as n,j as o,C as y,F as L,B as E,r as k,E as D,J as X,t as oe,A as ne,H as ie,K as G}from"./element-plus-DT46MLQ6.js";import{_ as H}from"./_plugin-vue_export-helper-DlAUqK2U.js";const de={key:0},re={style:{"font-family":"monospace",color:"#0891b2"}},ue={style:{"font-family":"monospace"}},me={style:{display:"grid","grid-template-columns":"repeat(2, 1fr)",gap:"8px"}},ce={style:{"margin-top":"8px"}},fe={style:{display:"flex","align-items":"center",gap:"8px"}},pe={style:{"font-family":"monospace",color:"#0891b2","font-weight":"500"}},ve={style:{"font-family":"monospace"}},ge=j({__name:"TaskDetailModal",props:{visible:{type:Boolean},task:{}},emits:["update:visible","cancel"],setup(l,{emit:z}){const M=z,S=l,u=k(!1),T=async()=>{if(S.task)try{u.value=!0,await R.delete(S.task.taskId),D.success("任务已取消"),M("cancel")}catch{D.error("取消任务失败")}finally{u.value=!1}},_=b=>({pending:"等待中",running:"运行中",completed:"已完成",failed:"失败",cancelled:"已取消"})[b]||b,$=b=>({pending:"info",running:"warning",completed:"success",failed:"danger",cancelled:"info"})[b]||"info",C=b=>b?new Date(b).toLocaleString():"-";return(b,i)=>{const f=r("el-descriptions-item"),N=r("el-tag"),A=r("el-descriptions"),p=r("el-divider"),m=r("el-scrollbar"),U=r("el-alert"),w=r("el-table-column"),x=r("el-table"),a=r("el-button"),B=r("el-dialog"),c=X("loading");return d(),v(B,{"model-value":l.visible,"onUpdate:modelValue":i[1]||(i[1]=V=>M("update:visible",V)),title:"任务详情",width:"900px"},{footer:e(()=>[t(a,{onClick:i[0]||(i[0]=V=>M("update:visible",!1))},{default:e(()=>[...i[10]||(i[10]=[o("关闭",-1)])]),_:1}),l.task&&(l.task.status==="pending"||l.task.status==="running")?(d(),v(a,{key:0,type:"danger",loading:u.value,onClick:T},{default:e(()=>[...i[11]||(i[11]=[o(" 取消任务 ",-1)])]),_:1},8,["loading"])):y("",!0)]),default:e(()=>[l.task?Q((d(),I("div",de,[t(A,{column:2,border:""},{default:e(()=>[t(f,{label:"任务ID"},{default:e(()=>[g("span",re,n(l.task.taskId),1)]),_:1}),t(f,{label:"状态"},{default:e(()=>[t(N,{type:$(l.task.status)},{default:e(()=>[o(n(_(l.task.status)),1)]),_:1},8,["type"])]),_:1}),t(f,{label:"优先级"},{default:e(()=>[o(n(l.task.priority),1)]),_:1}),t(f,{label:"批次大小"},{default:e(()=>[o(n(l.task.batchSize),1)]),_:1}),t(f,{label:"创建时间"},{default:e(()=>[o(n(C(l.task.createdAt)),1)]),_:1}),l.task.startedAt?(d(),v(f,{key:0,label:"开始时间"},{default:e(()=>[o(n(C(l.task.startedAt)),1)]),_:1})):y("",!0),l.task.finishedAt?(d(),v(f,{key:1,label:"完成时间"},{default:e(()=>[o(n(C(l.task.finishedAt)),1)]),_:1})):y("",!0),t(f,{label:"重试次数"},{default:e(()=>[o(n(l.task.retryCount)+" / "+n(l.task.maxRetries),1)]),_:1}),t(f,{label:"重试策略"},{default:e(()=>[o(n(l.task.retryStrategy==="linear"?"线性":"指数退避"),1)]),_:1}),l.task.retryDelay?(d(),v(f,{key:2,label:"重试延迟"},{default:e(()=>[o(n(l.task.retryDelay)+" 秒 ",1)]),_:1})):y("",!0),l.task.webhookUrl?(d(),v(f,{key:3,label:"Webhook URL"},{default:e(()=>[g("span",ue,n(l.task.webhookUrl),1)]),_:1})):y("",!0)]),_:1}),t(p,{"content-position":"left"},{default:e(()=>[...i[2]||(i[2]=[o("进度",-1)])]),_:1}),l.task.progress?(d(),v(A,{key:0,column:3,border:""},{default:e(()=>[t(f,{label:"总节点数"},{default:e(()=>[o(n(l.task.progress.totalNodes),1)]),_:1}),t(f,{label:"已完成"},{default:e(()=>[o(n(l.task.progress.completedNodes),1)]),_:1}),t(f,{label:"失败"},{default:e(()=>[o(n(l.task.progress.failedNodes),1)]),_:1}),t(f,{label:"当前批次"},{default:e(()=>[o(n(l.task.progress.currentBatch)+" / "+n(l.task.progress.totalBatches),1)]),_:1}),t(f,{label:"完成率"},{default:e(()=>[o(n(l.task.progress.percentage.toFixed(1))+"% ",1)]),_:1})]),_:1})):y("",!0),t(p,{"content-position":"left"},{default:e(()=>[...i[3]||(i[3]=[o("镜像列表",-1)])]),_:1}),t(m,{"max-height":"200px"},{default:e(()=>[g("div",me,[(d(!0),I(L,null,E(l.task.images,(V,h)=>(d(),v(N,{key:h,style:{"font-family":"monospace","font-size":"13px"}},{default:e(()=>[o(n(V),1)]),_:2},1024))),128))])]),_:1}),l.task.secretName?(d(),v(p,{key:1,"content-position":"left"},{default:e(()=>[...i[4]||(i[4]=[o("私有仓库认证",-1)])]),_:1})):y("",!0),l.task.secretName?(d(),v(U,{key:2,type:"info",closable:!1,style:{"margin-bottom":"24px"}},{title:e(()=>[...i[5]||(i[5]=[g("span",{style:{"font-weight":"600"}},"已启用私有仓库认证",-1)])]),default:e(()=>[g("div",ce,[g("div",fe,[i[6]||(i[6]=g("span",null,"Secret 名称：",-1)),g("span",pe,n(l.task.secretName),1)]),i[7]||(i[7]=g("div",{style:{"font-size":"12px",color:"#64748b","margin-top":"4px"}}," 临时 Secret 会在任务完成后自动清理 ",-1))])]),_:1})):y("",!0),l.task.errorMessage?(d(),v(p,{key:3,"content-position":"left"},{default:e(()=>[...i[8]||(i[8]=[o("错误信息",-1)])]),_:1})):y("",!0),l.task.errorMessage?(d(),v(U,{key:4,type:"error",closable:!1},{default:e(()=>[o(n(l.task.errorMessage),1)]),_:1})):y("",!0),l.task.failedNodeDetails&&l.task.failedNodeDetails.length>0?(d(),v(p,{key:5,"content-position":"left"},{default:e(()=>[...i[9]||(i[9]=[o("失败节点详情",-1)])]),_:1})):y("",!0),l.task.failedNodeDetails&&l.task.failedNodeDetails.length>0?(d(),v(x,{key:6,data:l.task.failedNodeDetails,style:{width:"100%","margin-top":"8px"},"max-height":"200px"},{default:e(()=>[t(w,{prop:"nodeName",label:"节点名称",width:"200"}),t(w,{prop:"image",label:"镜像","min-width":"250"},{default:e(({row:V})=>[g("span",ve,n(V.image),1)]),_:1}),t(w,{prop:"reason",label:"原因",width:"120"}),t(w,{prop:"message",label:"消息"},{default:e(({row:V})=>[o(n(V.message||"-"),1)]),_:1}),t(w,{prop:"timestamp",label:"时间",width:"180"},{default:e(({row:V})=>[o(n(new Date(V.timestamp).toLocaleString()),1)]),_:1})]),_:1},8,["data"])):y("",!0)])),[[c,u.value]]):y("",!0)]),_:1},8,["model-value"])}}}),ye=H(ge,[["__scopeId","data-v-de8617c9"]]),be={class:"image-picker"},ke={class:"image-item"},_e={class:"image-name"},we={class:"image-url"},xe={key:0,class:"loading-text"},Ve={class:"selected-images"},he={style:{float:"left"}},Ce={style:{float:"right",color:"#8492a6","font-size":"12px"}},De=j({__name:"CreateTaskModal",props:{visible:{type:Boolean}},emits:["update:visible","success"],setup(l,{expose:z,emit:M}){const S=M,u=k({images:[],batchSize:10,priority:5,maxRetries:0,retryStrategy:"linear",retryDelay:30,nodeSelector:{}}),T=k(!1),_=k("manual"),$=k([]),C=k([]),b=k([]),i=k(!1),f=k(!1),N=k(!1),A=async()=>{try{f.value=!0;const x=await ae.list({limit:100});C.value=x.images}catch{D.error("加载镜像库失败")}finally{f.value=!1}},p=async()=>{try{N.value=!0;const x=await se.list({pageSize:100});b.value=x.secrets}catch{D.error("加载认证信息失败")}finally{N.value=!1}},m=()=>{A(),p()},U=()=>{S("update:visible",!1)},w=async()=>{try{const x=$.value.map(a=>C.value.find(B=>B.id===a)?.image).filter(a=>!!a);if(x.length===0){D.warning("请至少选择一个镜像");return}u.value.images=x,i.value=!0,await R.create(u.value),D.success("任务创建成功"),S("success"),U()}catch(x){D.error(x.response?.data?.error||"创建任务失败")}finally{i.value=!1}};return z({handleOpen:m}),(x,a)=>{const B=r("el-checkbox"),c=r("el-empty"),V=r("el-checkbox-group"),h=r("el-form-item"),Y=r("el-tag"),F=r("el-input-number"),Z=r("el-switch"),J=r("el-radio"),ee=r("el-radio-group"),O=r("el-input"),P=r("el-option"),K=r("el-select"),te=r("el-form"),W=r("el-button"),le=r("el-dialog");return d(),v(le,{"model-value":l.visible,"onUpdate:modelValue":a[11]||(a[11]=s=>S("update:visible",s)),title:"创建镜像预热任务",width:"800px",onOpen:m},{footer:e(()=>[t(W,{onClick:U},{default:e(()=>[...a[14]||(a[14]=[o("取消",-1)])]),_:1}),t(W,{type:"primary",onClick:w,loading:i.value},{default:e(()=>[...a[15]||(a[15]=[o(" 创建任务 ",-1)])]),_:1},8,["loading"])]),default:e(()=>[t(te,{"label-width":"120px"},{default:e(()=>[t(h,{label:"镜像列表"},{default:e(()=>[t(V,{modelValue:$.value,"onUpdate:modelValue":a[0]||(a[0]=s=>$.value=s)},{default:e(()=>[g("div",be,[(d(!0),I(L,null,E(C.value,s=>(d(),v(B,{key:s.id,label:s.id,border:""},{default:e(()=>[g("div",ke,[g("div",_e,n(s.name),1),g("div",we,n(s.image),1)])]),_:2},1032,["label"]))),128))]),f.value?(d(),I("div",xe,"加载中...")):C.value.length===0?(d(),v(c,{key:1,description:"暂无镜像","image-size":80})):y("",!0)]),_:1},8,["modelValue"])]),_:1}),t(h,{label:"已选镜像"},{default:e(()=>[g("div",Ve,[(d(!0),I(L,null,E($.value,s=>(d(),v(Y,{key:s,closable:"",onClose:()=>{const q=$.value.indexOf(s);q>-1&&$.value.splice(q,1)}},{default:e(()=>[o(n(C.value.find(q=>q.id===s)?.name),1)]),_:2},1032,["onClose"]))),128))])]),_:1}),t(h,{label:"批次大小"},{default:e(()=>[t(F,{modelValue:u.value.batchSize,"onUpdate:modelValue":a[1]||(a[1]=s=>u.value.batchSize=s),min:1,max:100},null,8,["modelValue"])]),_:1}),t(h,{label:"优先级"},{default:e(()=>[t(F,{modelValue:u.value.priority,"onUpdate:modelValue":a[2]||(a[2]=s=>u.value.priority=s),min:1,max:10},null,8,["modelValue"])]),_:1}),t(h,{label:"私有仓库"},{default:e(()=>[t(Z,{modelValue:T.value,"onUpdate:modelValue":a[3]||(a[3]=s=>T.value=s)},null,8,["modelValue"])]),_:1}),T.value?(d(),I(L,{key:0},[t(h,{label:"认证方式"},{default:e(()=>[t(ee,{modelValue:_.value,"onUpdate:modelValue":a[4]||(a[4]=s=>_.value=s)},{default:e(()=>[t(J,{value:"manual"},{default:e(()=>[...a[12]||(a[12]=[o("手动输入",-1)])]),_:1}),t(J,{value:"select"},{default:e(()=>[...a[13]||(a[13]=[o("选择已保存",-1)])]),_:1})]),_:1},8,["modelValue"])]),_:1}),_.value==="manual"?(d(),I(L,{key:0},[t(h,{label:"仓库地址",required:""},{default:e(()=>[t(O,{modelValue:u.value.registry,"onUpdate:modelValue":a[5]||(a[5]=s=>u.value.registry=s),placeholder:"harbor.example.com"},null,8,["modelValue"])]),_:1}),t(h,{label:"用户名",required:""},{default:e(()=>[t(O,{modelValue:u.value.username,"onUpdate:modelValue":a[6]||(a[6]=s=>u.value.username=s)},null,8,["modelValue"])]),_:1}),t(h,{label:"密码",required:""},{default:e(()=>[t(O,{modelValue:u.value.password,"onUpdate:modelValue":a[7]||(a[7]=s=>u.value.password=s),type:"password","show-password":""},null,8,["modelValue"])]),_:1})],64)):y("",!0),_.value==="select"?(d(),v(h,{key:1,label:"选择认证",required:""},{default:e(()=>[t(K,{modelValue:u.value.secretId,"onUpdate:modelValue":a[8]||(a[8]=s=>u.value.secretId=s),placeholder:"请选择认证",style:{width:"100%"}},{default:e(()=>[(d(!0),I(L,null,E(b.value,s=>(d(),v(P,{key:s.id,label:s.name,value:s.id},{default:e(()=>[g("span",he,n(s.name),1),g("span",Ce,n(s.registry),1)]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})):y("",!0)],64)):y("",!0),t(h,{label:"最大重试"},{default:e(()=>[t(F,{modelValue:u.value.maxRetries,"onUpdate:modelValue":a[9]||(a[9]=s=>u.value.maxRetries=s),min:0,max:5},null,8,["modelValue"])]),_:1}),t(h,{label:"重试策略"},{default:e(()=>[t(K,{modelValue:u.value.retryStrategy,"onUpdate:modelValue":a[10]||(a[10]=s=>u.value.retryStrategy=s)},{default:e(()=>[t(P,{label:"线性",value:"linear"}),t(P,{label:"指数退避",value:"exponential"})]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1},8,["model-value"])}}}),Se=H(De,[["__scopeId","data-v-d58957dc"]]),$e={class:"tasks"},Ue={class:"header"},Ie={class:"header-right"},Me={key:0},Te=j({__name:"TasksView",setup(l){const z=k([]),M=k(!1),S=k(!1),u=k(!1),T=k(null),_=k([]),$=k(null);let C=null;const b=async()=>{try{M.value=!0;const p=await R.list({limit:10,offset:0});z.value=p.tasks}catch{D.error("加载任务失败")}finally{M.value=!1}},i=()=>{b()};oe(S,p=>{p&&$.value&&$.value.handleOpen()});const f=p=>{T.value=p,u.value=!0},N=async p=>{try{await G.confirm("确定要删除这个任务吗？","确认删除",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await R.delete(p.taskId),D.success("任务已删除"),b()}catch(m){m!=="cancel"&&D.error("删除失败")}},A=async()=>{if(_.value.length===0){D.warning("请选择要删除的任务");return}try{await G.confirm(`确定要删除选中的 ${_.value.length} 个任务吗？`,"确认批量删除",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});const p=_.value.map(m=>R.delete(m.taskId));await Promise.all(p),D.success(`成功删除了 ${p.length} 个任务`),_.value=[],b()}catch(p){p!=="cancel"&&D.error("批量删除失败")}};return ne(()=>{b(),C=window.setInterval(()=>{b()},5e3)}),ie(()=>{C&&clearInterval(C)}),(p,m)=>{const U=r("el-button"),w=r("el-table-column"),x=r("el-tag"),a=r("el-table"),B=X("loading");return d(),I("div",$e,[g("div",Ue,[m[5]||(m[5]=g("h2",null,"任务管理",-1)),g("div",Ie,[_.value.length>0?(d(),v(U,{key:0,type:"danger",onClick:A,disabled:_.value.length===0},{default:e(()=>[o(" 批量删除 ("+n(_.value.length)+") ",1)]),_:1},8,["disabled"])):y("",!0),t(U,{type:"primary",onClick:m[0]||(m[0]=c=>S.value=!0)},{default:e(()=>[...m[4]||(m[4]=[o("新建任务",-1)])]),_:1})])]),Q((d(),v(a,{data:z.value,style:{width:"100%"},onSelectionChange:m[1]||(m[1]=c=>_.value=c)},{default:e(()=>[t(w,{type:"selection",width:"55"}),t(w,{prop:"taskId",label:"任务ID",width:"180"}),t(w,{prop:"status",label:"状态",width:"100"},{default:e(({row:c})=>[t(x,{type:c.status==="completed"?"success":c.status==="failed"?"danger":"info"},{default:e(()=>[o(n(c.status),1)]),_:2},1032,["type"])]),_:1}),t(w,{prop:"images",label:"镜像"},{default:e(({row:c})=>[o(n(c.images[0])+" ",1),c.images.length>1?(d(),I("span",Me,"+"+n(c.images.length-1),1)):y("",!0)]),_:1}),t(w,{prop:"progress.percentage",label:"进度",width:"120"},{default:e(({row:c})=>[o(n(c.progress?.percentage?.toFixed(1)||0)+"% ",1)]),_:1}),t(w,{prop:"createdAt",label:"创建时间",width:"180"},{default:e(({row:c})=>[o(n(new Date(c.createdAt).toLocaleString()),1)]),_:1}),t(w,{label:"操作",width:"200"},{default:e(({row:c})=>[t(U,{size:"small",onClick:V=>f(c)},{default:e(()=>[...m[6]||(m[6]=[o("详情",-1)])]),_:1},8,["onClick"]),t(U,{size:"small",type:"danger",onClick:V=>N(c)},{default:e(()=>[...m[7]||(m[7]=[o("删除",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[B,M.value]]),t(Se,{visible:S.value,"onUpdate:visible":m[2]||(m[2]=c=>S.value=c),onSuccess:i},null,8,["visible"]),t(ye,{visible:u.value,task:T.value,"onUpdate:visible":m[3]||(m[3]=c=>u.value=c)},null,8,["visible","task"])])}}}),Ae=H(Te,[["__scopeId","data-v-5f43b0fe"]]);export{Ae as default};
